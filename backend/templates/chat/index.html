{% extends 'base.html' %}

{% block title %}智能对话 - {{ block.super }}{% endblock %}

{% block extra_head %}
<!-- Markdown渲染库 - 使用多个CDN源作为备选 -->
<script src="https://unpkg.com/marked@11.1.1/marked.min.js" 
        onerror="this.onerror=null; this.src='https://cdn.bootcdn.net/ajax/libs/marked/11.1.1/marked.min.js'"></script>
<!-- 代码高亮库 -->
<link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/styles/github.min.css" 
      onerror="this.onerror=null; this.href='https://cdn.bootcdn.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css'">
<script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js"
        onerror="this.onerror=null; this.src='https://cdn.bootcdn.net/ajax/libs/highlight.js/11.9.0/highlight.min.js'"></script>
<!-- DOMPurify - 防止XSS攻击 -->
<script src="https://unpkg.com/dompurify@3.0.6/dist/purify.min.js"
        onerror="this.onerror=null; this.src='https://cdn.bootcdn.net/ajax/libs/dompurify/3.0.6/purify.min.js'"></script>
{% endblock %}
    
{% block content %}
<div class="page-content">
    <div class="page-header">
        <h1 class="page-title">RAG 智能问答系统</h1>
        <p class="page-subtitle">
            {% if user.is_authenticated %}
                欢迎, {{ user.username }}！
            {% else %}
                欢迎使用智能问答系统，<a href="{% url 'login' %}">登录</a>获得更好体验
            {% endif %}
        </p>
    </div>

    <div style="display: grid; grid-template-columns: 250px 1fr; gap: 20px; height: calc(100vh - 200px);">
        <!-- 会话列表侧边栏 -->
        <div class="sessions-sidebar" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0; color: #333;">对话历史</h3>
                <button onclick="createNewSession()" class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;">新对话</button>
            </div>
            
            <div class="sessions-list">
                {% if sessions %}
                    {% for session in sessions %}
                    <div class="session-item" data-session-id="{{ session.id }}" data-session-title="{{ session.title|escapejs }}"
                         style="padding: 10px; margin-bottom: 8px; background: #f8f9fa; border-radius: 5px; position: relative; border: 1px solid #e9ecef;">
                        <div class="session-content" style="cursor: pointer;">
                            <div class="session-title" style="font-weight: 500; font-size: 14px; color: #333; margin-bottom: 2px; padding-right: 30px;">{{ session.title|truncatechars:30 }}</div>
                            <div style="font-size: 11px; color: #666;">{{ session.updated_at|date:"m-d H:i" }}</div>
                        </div>
                        <div class="session-actions" style="position: absolute; top: 8px; right: 8px; display: none;">
                            <button class="rename-btn" 
                                    style="background: none; border: none; cursor: pointer; padding: 4px; color: #007bff; font-size: 14px;"
                                    title="重命名">
                                ✏️
                            </button>
                        </div>
                        <div class="session-edit" style="display: none; padding: 5px 0;">
                            <input type="text" class="rename-input" 
                                   style="width: 100%; padding: 5px; border: 1px solid #007bff; border-radius: 3px; font-size: 14px;">
                            <div style="margin-top: 5px; font-size: 11px; color: #666;">
                                按回车保存，点击外部取消
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div style="text-align: center; color: #666; padding: 20px;">
                        <p>暂无对话记录</p>
                        <p style="font-size: 12px;">开始您的第一次对话吧！</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- 聊天区域 -->
        <div class="chat-container" style="background: white; border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <!-- 聊天消息区域 -->
            <div class="chat-messages" id="chatMessages" style="flex: 1; padding: 20px; overflow-y: auto; border-bottom: 1px solid #e9ecef;">
                <div class="welcome-message" style="text-align: center; color: #666; padding: 40px 20px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">🤖</div>
                    <h3 style="margin: 0 0 10px 0;">您好！我是AI助手</h3>
                    <p>我可以回答您的问题、协助解决问题，或者与您进行对话交流。</p>
                    <p style="font-size: 14px; margin-top: 20px;">请在下方输入您的问题开始对话...</p>
                </div>
            </div>

            <!-- 输入区域 -->
            <div class="chat-input-container" style="padding: 20px;">
                <!-- 模型选择器 -->
                <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                    <label for="modelSelect" style="font-size: 14px; color: #666; margin: 0;">选择模型：</label>
                    <select id="modelSelect" class="form-control" style="width: auto; font-size: 14px;">
                        <option value="">加载中...</option>
                    </select>
                    <span id="modelStatus" style="font-size: 12px; color: #28a745;"></span>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <input 
                        type="text" 
                        id="messageInput" 
                        placeholder="请输入您的问题..." 
                        class="form-control"
                        style="flex: 1;"
                        onkeypress="handleKeyPress(event)"
                    >
                    <button onclick="sendMessage()" class="btn btn-primary" style="padding: 10px 20px;">
                        发送
                    </button>
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 8px; text-align: center;">
                    按 Enter 发送，Shift+Enter 换行
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* 会话列表项样式 */
.session-item {
    transition: all 0.2s ease;
}

.session-item:hover {
    background: #e3f2fd !important;
    transform: translateX(2px);
}

.session-item:hover .session-actions {
    display: block !important;
}

.session-item.active {
    background: #e3f2fd !important;
    border: 2px solid #007bff !important;
}

.rename-btn {
    transition: transform 0.2s ease;
}

.rename-btn:hover {
    transform: scale(1.2);
}

.rename-input {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.rename-input:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
}

/* 聊天相关样式 */
.message {
    margin-bottom: 15px;
    display: flex;
    align-items: flex-start;
}

.message.user {
    justify-content: flex-end;
}

.message-content {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    line-height: 1.4;
}

.message.user .message-content {
    background: #007bff;
    color: white;
    margin-left: 20px;
}

.message.ai .message-content {
    background: #f1f3f4;
    color: #333;
    margin-right: 20px;
}

/* AI消息内容格式化样式 */
.message.ai .message-content {
    overflow-wrap: break-word;
    word-wrap: break-word;
}

.message.ai .message-content p {
    margin: 0.5em 0;
    line-height: 1.6;
}

.message.ai .message-content p:first-child {
    margin-top: 0;
}

.message.ai .message-content p:last-child {
    margin-bottom: 0;
}

/* 标题样式 */
.message.ai .message-content h1,
.message.ai .message-content h2,
.message.ai .message-content h3,
.message.ai .message-content h4,
.message.ai .message-content h5,
.message.ai .message-content h6 {
    margin: 1em 0 0.5em 0;
    font-weight: 600;
    line-height: 1.3;
}

.message.ai .message-content h1 { font-size: 1.5em; border-bottom: 2px solid #ddd; padding-bottom: 0.3em; }
.message.ai .message-content h2 { font-size: 1.3em; border-bottom: 1px solid #eee; padding-bottom: 0.2em; }
.message.ai .message-content h3 { font-size: 1.1em; }

/* 列表样式 */
.message.ai .message-content ul,
.message.ai .message-content ol {
    margin: 0.5em 0;
    padding-left: 2em;
}

.message.ai .message-content li {
    margin: 0.3em 0;
    line-height: 1.6;
}

/* 表格样式 */
.message.ai .message-content table {
    border-collapse: collapse;
    width: 100%;
    margin: 1em 0;
    font-size: 0.9em;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
}

.message.ai .message-content table thead tr {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-align: left;
    font-weight: 600;
}

.message.ai .message-content table th,
.message.ai .message-content table td {
    padding: 12px 15px;
    border: 1px solid #ddd;
}

.message.ai .message-content table tbody tr {
    border-bottom: 1px solid #ddd;
    transition: background-color 0.2s;
}

.message.ai .message-content table tbody tr:nth-of-type(even) {
    background-color: #f8f9fa;
}

.message.ai .message-content table tbody tr:hover {
    background-color: #e9ecef;
}

.message.ai .message-content table tbody tr:last-of-type {
    border-bottom: 2px solid #667eea;
}

/* 代码块样式 */
.message.ai .message-content pre {
    background: #282c34;
    color: #abb2bf;
    padding: 1em;
    border-radius: 8px;
    overflow-x: auto;
    margin: 1em 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.message.ai .message-content pre code {
    background: none;
    padding: 0;
    color: inherit;
    font-size: 0.9em;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
}

/* 行内代码样式 */
.message.ai .message-content code {
    background: #f4f4f4;
    color: #e83e8c;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.9em;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
}

/* 引用样式 */
.message.ai .message-content blockquote {
    border-left: 4px solid #007bff;
    background: #f8f9fa;
    margin: 1em 0;
    padding: 0.5em 1em;
    font-style: italic;
    color: #555;
}

/* 分割线样式 */
.message.ai .message-content hr {
    border: none;
    border-top: 2px solid #e9ecef;
    margin: 1.5em 0;
}

/* 链接样式 */
.message.ai .message-content a {
    color: #007bff;
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s;
}

.message.ai .message-content a:hover {
    border-bottom-color: #007bff;
}

/* 强调文本 */
.message.ai .message-content strong {
    font-weight: 600;
    color: #333;
}

.message.ai .message-content em {
    font-style: italic;
    color: #555;
}

/* 图片样式 */
.message.ai .message-content img {
    max-width: 100%;
    border-radius: 8px;
    margin: 0.5em 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    flex-shrink: 0;
}

.message.user .message-avatar {
    background: #007bff;
    color: white;
    order: 1;
    margin-left: 10px;
}

.message.ai .message-avatar {
    background: #28a745;
    color: white;
    margin-right: 10px;
}

.session-item:hover {
    background: #e9ecef !important;
    border-color: #007bff !important;
}

.session-item.active {
    background: #007bff !important;
    color: white !important;
    border-color: #007bff !important;
}

.session-item.active div {
    color: white !important;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .page-content > div {
        grid-template-columns: 1fr !important;
        height: auto !important;
    }
    
    .sessions-sidebar {
        order: 1;
        max-height: 200px;
    }
    
    .chat-container {
        order: 0;
        height: 500px;
    }
}
</style>

<script>
let currentSessionId = null;
let isLoading = false;
let availableModels = [];
let selectedModel = null;

// 加载可用模型列表
async function loadAvailableModels() {
    try {
        const response = await fetch('/chat/api/models/');
        const data = await response.json();
        
        if (data.success && data.models) {
            availableModels = data.models;
            const modelSelect = document.getElementById('modelSelect');
            modelSelect.innerHTML = '';
            
            data.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });
            
            // 设置默认选中第二个模型（通义千问）
            if (data.models.length > 1) {
                modelSelect.selectedIndex = 1;
            }
            selectedModel = modelSelect.value;
            
            // 监听模型切换
            modelSelect.addEventListener('change', function() {
                selectedModel = this.value;
                updateModelStatus(selectedModel);
            });
            
            updateModelStatus(selectedModel);
        }
    } catch (error) {
        console.error('加载模型列表失败:', error);
        document.getElementById('modelSelect').innerHTML = '<option value="">加载失败</option>';
    }
}

// 更新模型状态显示
function updateModelStatus(model) {
    const statusEl = document.getElementById('modelStatus');
    if (model) {
        statusEl.textContent = `✓ 已选择: ${model}`;
        statusEl.style.color = '#28a745';
    } else {
        statusEl.textContent = '';
    }
}


// 发送消息
async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message || isLoading) return;
    
    // 清空输入框
    input.value = '';
    
    // 显示用户消息
    addMessage(message, true);
    
    // 显示加载状态
    isLoading = true;
    const loadingMessage = addMessage('正在思考中...', false, true);
    
    try {
        const response = await fetch('/chat/api/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                message: message,
                session_id: currentSessionId,
                model: selectedModel  // 添加模型参数
            })
        });
        
        const data = await response.json();
        
        // 移除加载消息
        loadingMessage.remove();
        
        if (data.success) {
            // 显示AI回复
            addMessage(data.response, false);
            
            // 更新当前会话ID
            if (data.session_id && !currentSessionId) {
                currentSessionId = data.session_id;
                // 动态添加新会话到列表（不刷新页面）
                addSessionToList(data.session_id, message);
            }
        } else {
            addMessage('抱歉，发生了错误：' + data.error, false);
        }
    } catch (error) {
        loadingMessage.remove();
        addMessage('网络错误，请稍后再试。', false);
        console.error('Error:', error);
    } finally {
        isLoading = false;
        input.focus();
    }
}

// 添加消息到聊天区域
function addMessage(content, isUser, isLoading = false) {
    const messagesContainer = document.getElementById('chatMessages');
    
    // 隐藏欢迎消息
    const welcomeMessage = messagesContainer.querySelector('.welcome-message');
    if (welcomeMessage) {
        welcomeMessage.style.display = 'none';
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
    
    const avatarDiv = document.createElement('div');
    avatarDiv.className = 'message-avatar';
    avatarDiv.textContent = isUser ? '👤' : '🤖';
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    if (isLoading) {
        contentDiv.innerHTML = '<span style="opacity: 0.7;">正在思考中...</span>';
    } else if (isUser) {
        // 用户消息：纯文本显示
        contentDiv.textContent = content;
    } else {
        // AI消息：使用Markdown渲染
        console.log('开始渲染Markdown，内容长度:', content.length);
        console.log('内容预览:', content.substring(0, 100));
        
        try {
            // 检查marked是否可用
            if (typeof marked === 'undefined') {
                console.error('❌ marked库未加载！');
                contentDiv.textContent = content;
                return;
            }
            
            // 配置marked选项
            marked.setOptions({
                breaks: true,  // 支持换行
                gfm: true,     // GitHub风格Markdown
                tables: true,  // 支持表格
                highlight: function(code, lang) {
                    // 代码高亮
                    if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                        try {
                            return hljs.highlight(code, { language: lang }).value;
                        } catch (err) {
                            console.warn('代码高亮失败:', err);
                        }
                    }
                    return typeof hljs !== 'undefined' ? hljs.highlightAuto(code).value : code;
                }
            });
            
            // 渲染Markdown
            const rawHtml = marked.parse(content);
            console.log('Markdown渲染完成，HTML长度:', rawHtml.length);
            
            // 使用DOMPurify清理HTML，防止XSS攻击
            if (typeof DOMPurify !== 'undefined') {
                const cleanHtml = DOMPurify.sanitize(rawHtml, {
                    ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u', 's', 'code', 'pre', 
                                  'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                                  'ul', 'ol', 'li', 'blockquote', 'hr',
                                  'table', 'thead', 'tbody', 'tr', 'th', 'td',
                                  'a', 'img', 'span', 'div'],
                    ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'style']
                });
                contentDiv.innerHTML = cleanHtml;
                console.log('✅ HTML已清理并插入');
            } else {
                console.warn('⚠️ DOMPurify未加载，直接使用HTML');
                contentDiv.innerHTML = rawHtml;
            }
            
            // 对代码块应用高亮
            if (typeof hljs !== 'undefined') {
                contentDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
                console.log('✅ 代码高亮应用完成');
            }
        } catch (error) {
            console.error('❌ Markdown渲染错误:', error);
            contentDiv.textContent = content;
        }
    }
    
    messageDiv.appendChild(avatarDiv);
    messageDiv.appendChild(contentDiv);
    
    messagesContainer.appendChild(messageDiv);
    
    // 滚动到底部
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageDiv;
}

// 处理回车键
function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

// 创建新会话
function createNewSession() {
    currentSessionId = null;
    document.getElementById('chatMessages').innerHTML = `
        <div class="welcome-message" style="text-align: center; color: #666; padding: 40px 20px;">
            <div style="font-size: 48px; margin-bottom: 20px;">🤖</div>
            <h3 style="margin: 0 0 10px 0;">开始新的对话</h3>
            <p>请输入您的问题，我会尽力为您解答。</p>
        </div>
    `;
    
    // 移除所有会话的选中状态
    document.querySelectorAll('.session-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // 聚焦输入框
    document.getElementById('messageInput').focus();
}

// 动态添加新会话到列表
function addSessionToList(sessionId, firstMessage) {
    const sessionsList = document.querySelector('.sessions-list');
    
    // 移除"暂无对话记录"提示
    const emptyMessage = sessionsList.querySelector('div[style*="text-align: center"]');
    if (emptyMessage) {
        emptyMessage.remove();
    }
    
    // 创建新会话项
    const sessionItem = document.createElement('div');
    sessionItem.className = 'session-item active';
    sessionItem.dataset.sessionId = sessionId;
    sessionItem.style.cssText = 'padding: 10px; margin-bottom: 8px; background: #e3f2fd; border-radius: 5px; position: relative; border: 2px solid #007bff;';
    
    // 截取消息作为标题
    const title = firstMessage.length > 30 ? firstMessage.substring(0, 27) + '...' : firstMessage;
    const fullTitle = firstMessage; // 保存完整标题用于重命名
    
    // 获取当前时间
    const now = new Date();
    const timeStr = `${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    
    sessionItem.innerHTML = `
        <div class="session-content">
            <div class="session-title" style="font-weight: 500; font-size: 14px; color: #333; margin-bottom: 2px; padding-right: 30px;">${title}</div>
            <div style="font-size: 11px; color: #666;">${timeStr}</div>
        </div>
        <div class="session-actions" style="position: absolute; top: 8px; right: 8px; display: none;">
            <button class="rename-btn" 
                    style="background: none; border: none; cursor: pointer; padding: 4px; color: #007bff; font-size: 14px;"
                    title="重命名">
                ✏️
            </button>
        </div>
        <div class="session-edit" style="display: none; padding: 5px 0;">
            <input type="text" class="rename-input" 
                   style="width: 100%; padding: 5px; border: 1px solid #007bff; border-radius: 3px; font-size: 14px;">
            <div style="margin-top: 5px; font-size: 11px; color: #666;">
                按回车保存，点击外部取消
            </div>
        </div>
    `;
    
    // 添加点击事件 - 只在 session-content 上
    sessionItem.querySelector('.session-content').addEventListener('click', function() {
        loadSession(sessionId);
    });
    
    // 添加重命名按钮点击事件
    sessionItem.querySelector('.rename-btn').addEventListener('click', function(e) {
        e.stopPropagation();
        startRenameSession(sessionId, fullTitle);
    });
    
    // 添加输入框事件
    const input = sessionItem.querySelector('.rename-input');
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            saveRename(sessionId, this.value);
        }
    });
    input.addEventListener('blur', function() {
        setTimeout(() => cancelRename(sessionId), 200);
    });
    
    // 移除其他会话的选中状态
    document.querySelectorAll('.session-item').forEach(item => {
        item.classList.remove('active');
        item.style.background = '#f8f9fa';
        item.style.border = '1px solid #e9ecef';
    });
    
    // 插入到列表顶部
    sessionsList.insertBefore(sessionItem, sessionsList.firstChild);
}

// 页面加载完成后的初始化
document.addEventListener('DOMContentLoaded', function() {
    // 检查必要的库是否加载
    console.log('Marked库加载状态:', typeof marked !== 'undefined' ? '✅ 已加载' : '❌ 未加载');
    console.log('Highlight.js加载状态:', typeof hljs !== 'undefined' ? '✅ 已加载' : '❌ 未加载');
    console.log('DOMPurify加载状态:', typeof DOMPurify !== 'undefined' ? '✅ 已加载' : '❌ 未加载');
    
    // 聚焦输入框
    document.getElementById('messageInput').focus();
    
    // 加载可用模型
    loadAvailableModels();
    
    // 为会话项的内容区域添加点击事件
    document.querySelectorAll('.session-item').forEach(item => {
        const sessionId = item.dataset.sessionId;
        const sessionTitle = item.dataset.sessionTitle || '';
        
        console.log('为会话项绑定事件，ID:', sessionId, '标题:', sessionTitle);
        
        // 为内容区域添加点击事件
        const contentDiv = item.querySelector('.session-content');
        if (contentDiv) {
            contentDiv.addEventListener('click', function(e) {
                console.log('点击会话内容，加载会话:', sessionId);
                loadSession(sessionId);
            });
        }
        
        // 为重命名按钮添加点击事件
        const renameBtn = item.querySelector('.rename-btn');
        if (renameBtn) {
            console.log('找到重命名按钮，绑定事件');
            renameBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                e.preventDefault();
                console.log('点击重命名按钮，会话ID:', sessionId, '当前标题:', sessionTitle);
                startRenameSession(sessionId, sessionTitle);
            });
        } else {
            console.warn('未找到重命名按钮，会话ID:', sessionId);
        }
        
        // 为输入框添加事件
        const input = item.querySelector('.rename-input');
        if (input) {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveRename(sessionId, this.value);
                }
            });
            input.addEventListener('blur', function() {
                setTimeout(() => cancelRename(sessionId), 200);
            });
        }
    });
});

// 加载指定会话
async function loadSession(sessionId) {
    try {
        // 显示加载状态
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">加载中...</div>';
        
        // 请求会话历史
        const response = await fetch(`/chat/history/${sessionId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // 更新当前会话ID
            currentSessionId = sessionId;
            
            // 清空消息容器
            messagesContainer.innerHTML = '';
            
            // 如果没有消息，显示欢迎提示
            if (!data.messages || data.messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="welcome-message" style="text-align: center; color: #666; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">🤖</div>
                        <h3 style="margin: 0 0 10px 0;">开始对话</h3>
                        <p>这是一个新的会话，请输入您的问题。</p>
                    </div>
                `;
            } else {
                // 渲染历史消息
                data.messages.forEach(msg => {
                    addMessage(msg.content, msg.is_user);
                });
            }
            
            // 更新UI状态 - 高亮当前会话
            document.querySelectorAll('.session-item').forEach(item => {
                item.classList.remove('active');
                item.style.background = '#f8f9fa';
                item.style.border = '1px solid #e9ecef';
            });
            
            const activeSession = document.querySelector(`[data-session-id="${sessionId}"]`);
            if (activeSession) {
                activeSession.classList.add('active');
                activeSession.style.background = '#e3f2fd';
                activeSession.style.border = '2px solid #007bff';
            }
            
            // 聚焦输入框
            document.getElementById('messageInput').focus();
        } else {
            messagesContainer.innerHTML = `
                <div style="text-align: center; color: #dc3545; padding: 40px 20px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">❌</div>
                    <h3 style="margin: 0 0 10px 0;">加载失败</h3>
                    <p>${data.error || '无法加载会话历史'}</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('加载会话失败:', error);
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML = `
            <div style="text-align: center; color: #dc3545; padding: 40px 20px;">
                <div style="font-size: 48px; margin-bottom: 20px;">❌</div>
                <h3 style="margin: 0 0 10px 0;">网络错误</h3>
                <p>无法连接到服务器，请稍后再试。</p>
            </div>
        `;
    }
}

// 开始重命名会话
function startRenameSession(sessionId, currentTitle) {
    console.log('开始重命名会话，ID:', sessionId, '当前标题:', currentTitle);
    
    const sessionItem = document.querySelector(`[data-session-id="${sessionId}"]`);
    if (!sessionItem) {
        console.error('未找到会话项，ID:', sessionId);
        return;
    }
    
    console.log('找到会话项:', sessionItem);
    
    const contentDiv = sessionItem.querySelector('.session-content');
    const editDiv = sessionItem.querySelector('.session-edit');
    const input = sessionItem.querySelector('.rename-input');
    
    console.log('content div:', contentDiv);
    console.log('edit div:', editDiv);
    console.log('input:', input);
    
    if (!contentDiv || !editDiv || !input) {
        console.error('未找到必要的元素');
        return;
    }
    
    // 隐藏内容，显示编辑框
    contentDiv.style.display = 'none';
    editDiv.style.display = 'block';
    
    // 设置当前标题并选中
    input.value = currentTitle;
    input.focus();
    input.select();
    
    console.log('编辑模式已激活');
}

// 保存重命名
async function saveRename(sessionId, newTitle) {
    newTitle = newTitle.trim();
    
    if (!newTitle) {
        alert('标题不能为空');
        cancelRename(sessionId);
        return;
    }
    
    try {
        const response = await fetch(`/chat/rename/${sessionId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ title: newTitle })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // 更新UI显示
            const sessionItem = document.querySelector(`[data-session-id="${sessionId}"]`);
            const titleDiv = sessionItem.querySelector('.session-title');
            titleDiv.textContent = newTitle.length > 30 ? newTitle.substring(0, 27) + '...' : newTitle;
            
            // 隐藏编辑框，显示内容
            cancelRename(sessionId);
        } else {
            alert('重命名失败: ' + data.error);
            cancelRename(sessionId);
        }
    } catch (error) {
        console.error('重命名失败:', error);
        alert('网络错误，请稍后再试');
        cancelRename(sessionId);
    }
}

// 取消重命名
function cancelRename(sessionId) {
    const sessionItem = document.querySelector(`[data-session-id="${sessionId}"]`);
    if (!sessionItem) return;
    
    const contentDiv = sessionItem.querySelector('.session-content');
    const editDiv = sessionItem.querySelector('.session-edit');
    
    // 显示内容，隐藏编辑框
    contentDiv.style.display = 'block';
    editDiv.style.display = 'none';
}
</script>
{% endblock %}
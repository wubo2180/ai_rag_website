{% extends 'base.html' %}

{% block title %}æ™ºèƒ½å¯¹è¯ - {{ block.super }}{% endblock %}

{% block extra_head %}
<!-- Markdownæ¸²æŸ“åº“ - ä½¿ç”¨å¤šä¸ªCDNæºä½œä¸ºå¤‡é€‰ -->
<script src="https://unpkg.com/marked@11.1.1/marked.min.js" 
        onerror="this.onerror=null; this.src='https://cdn.bootcdn.net/ajax/libs/marked/11.1.1/marked.min.js'"></script>
<!-- ä»£ç é«˜äº®åº“ -->
<link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/styles/github.min.css" 
      onerror="this.onerror=null; this.href='https://cdn.bootcdn.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css'">
<script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js"
        onerror="this.onerror=null; this.src='https://cdn.bootcdn.net/ajax/libs/highlight.js/11.9.0/highlight.min.js'"></script>
<!-- DOMPurify - é˜²æ­¢XSSæ”»å‡» -->
<script src="https://unpkg.com/dompurify@3.0.6/dist/purify.min.js"
        onerror="this.onerror=null; this.src='https://cdn.bootcdn.net/ajax/libs/dompurify/3.0.6/purify.min.js'"></script>
{% endblock %}
    
{% block content %}
<div class="page-content">
    <div class="page-header">
        <h1 class="page-title">RAG æ™ºèƒ½é—®ç­”ç³»ç»Ÿ</h1>
        <p class="page-subtitle">
            {% if user.is_authenticated %}
                æ¬¢è¿, {{ user.username }}ï¼
            {% else %}
                æ¬¢è¿ä½¿ç”¨æ™ºèƒ½é—®ç­”ç³»ç»Ÿï¼Œ<a href="{% url 'login' %}">ç™»å½•</a>è·å¾—æ›´å¥½ä½“éªŒ
            {% endif %}
        </p>
    </div>

    <div style="display: grid; grid-template-columns: 250px 1fr; gap: 20px; height: calc(100vh - 200px);">
        <!-- ä¼šè¯åˆ—è¡¨ä¾§è¾¹æ  -->
        <div class="sessions-sidebar" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0; color: #333;">å¯¹è¯å†å²</h3>
                <button onclick="createNewSession()" class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;">æ–°å¯¹è¯</button>
            </div>
            
            <div class="sessions-list">
                {% if sessions %}
                    {% for session in sessions %}
                    <div class="session-item" data-session-id="{{ session.id }}" data-session-title="{{ session.title|escapejs }}"
                         style="padding: 10px; margin-bottom: 8px; background: #f8f9fa; border-radius: 5px; position: relative; border: 1px solid #e9ecef;">
                        <div class="session-content" style="cursor: pointer;">
                            <div class="session-title" style="font-weight: 500; font-size: 14px; color: #333; margin-bottom: 2px; padding-right: 30px;">{{ session.title|truncatechars:30 }}</div>
                            <div style="font-size: 11px; color: #666;">{{ session.updated_at|date:"m-d H:i" }}</div>
                        </div>
                        <div class="session-actions" style="position: absolute; top: 8px; right: 8px; display: none;">
                            <button class="rename-btn" 
                                    style="background: none; border: none; cursor: pointer; padding: 4px; color: #007bff; font-size: 14px;"
                                    title="é‡å‘½å">
                                âœï¸
                            </button>
                        </div>
                        <div class="session-edit" style="display: none; padding: 5px 0;">
                            <input type="text" class="rename-input" 
                                   style="width: 100%; padding: 5px; border: 1px solid #007bff; border-radius: 3px; font-size: 14px;">
                            <div style="margin-top: 5px; font-size: 11px; color: #666;">
                                æŒ‰å›è½¦ä¿å­˜ï¼Œç‚¹å‡»å¤–éƒ¨å–æ¶ˆ
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div style="text-align: center; color: #666; padding: 20px;">
                        <p>æš‚æ— å¯¹è¯è®°å½•</p>
                        <p style="font-size: 12px;">å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡å¯¹è¯å§ï¼</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- èŠå¤©åŒºåŸŸ -->
        <div class="chat-container" style="background: white; border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
            <div class="chat-messages" id="chatMessages" style="flex: 1; padding: 20px; overflow-y: auto; border-bottom: 1px solid #e9ecef;">
                <div class="welcome-message" style="text-align: center; color: #666; padding: 40px 20px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">ğŸ¤–</div>
                    <h3 style="margin: 0 0 10px 0;">æ‚¨å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹</h3>
                    <p>æˆ‘å¯ä»¥å›ç­”æ‚¨çš„é—®é¢˜ã€ååŠ©è§£å†³é—®é¢˜ï¼Œæˆ–è€…ä¸æ‚¨è¿›è¡Œå¯¹è¯äº¤æµã€‚</p>
                    <p style="font-size: 14px; margin-top: 20px;">è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ‚¨çš„é—®é¢˜å¼€å§‹å¯¹è¯...</p>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="chat-input-container" style="padding: 20px;">
                <!-- æ¨¡å‹é€‰æ‹©å™¨ -->
                <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                    <label for="modelSelect" style="font-size: 14px; color: #666; margin: 0;">é€‰æ‹©æ¨¡å‹ï¼š</label>
                    <select id="modelSelect" class="form-control" style="width: auto; font-size: 14px;">
                        <option value="">åŠ è½½ä¸­...</option>
                    </select>
                    <span id="modelStatus" style="font-size: 12px; color: #28a745;"></span>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <input 
                        type="text" 
                        id="messageInput" 
                        placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." 
                        class="form-control"
                        style="flex: 1;"
                        onkeypress="handleKeyPress(event)"
                    >
                    <button onclick="sendMessage()" class="btn btn-primary" style="padding: 10px 20px;">
                        å‘é€
                    </button>
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 8px; text-align: center;">
                    æŒ‰ Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* ä¼šè¯åˆ—è¡¨é¡¹æ ·å¼ */
.session-item {
    transition: all 0.2s ease;
}

.session-item:hover {
    background: #e3f2fd !important;
    transform: translateX(2px);
}

.session-item:hover .session-actions {
    display: block !important;
}

.session-item.active {
    background: #e3f2fd !important;
    border: 2px solid #007bff !important;
}

.rename-btn {
    transition: transform 0.2s ease;
}

.rename-btn:hover {
    transform: scale(1.2);
}

.rename-input {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.rename-input:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
}

/* èŠå¤©ç›¸å…³æ ·å¼ */
.message {
    margin-bottom: 15px;
    display: flex;
    align-items: flex-start;
}

.message.user {
    justify-content: flex-end;
}

.message-content {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    line-height: 1.4;
}

.message.user .message-content {
    background: #007bff;
    color: white;
    margin-left: 20px;
}

.message.ai .message-content {
    background: #f1f3f4;
    color: #333;
    margin-right: 20px;
}

/* AIæ¶ˆæ¯å†…å®¹æ ¼å¼åŒ–æ ·å¼ */
.message.ai .message-content {
    overflow-wrap: break-word;
    word-wrap: break-word;
}

.message.ai .message-content p {
    margin: 0.5em 0;
    line-height: 1.6;
}

.message.ai .message-content p:first-child {
    margin-top: 0;
}

.message.ai .message-content p:last-child {
    margin-bottom: 0;
}

/* æ ‡é¢˜æ ·å¼ */
.message.ai .message-content h1,
.message.ai .message-content h2,
.message.ai .message-content h3,
.message.ai .message-content h4,
.message.ai .message-content h5,
.message.ai .message-content h6 {
    margin: 1em 0 0.5em 0;
    font-weight: 600;
    line-height: 1.3;
}

.message.ai .message-content h1 { font-size: 1.5em; border-bottom: 2px solid #ddd; padding-bottom: 0.3em; }
.message.ai .message-content h2 { font-size: 1.3em; border-bottom: 1px solid #eee; padding-bottom: 0.2em; }
.message.ai .message-content h3 { font-size: 1.1em; }

/* åˆ—è¡¨æ ·å¼ */
.message.ai .message-content ul,
.message.ai .message-content ol {
    margin: 0.5em 0;
    padding-left: 2em;
}

.message.ai .message-content li {
    margin: 0.3em 0;
    line-height: 1.6;
}

/* è¡¨æ ¼æ ·å¼ */
.message.ai .message-content table {
    border-collapse: collapse;
    width: 100%;
    margin: 1em 0;
    font-size: 0.9em;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
}

.message.ai .message-content table thead tr {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-align: left;
    font-weight: 600;
}

.message.ai .message-content table th,
.message.ai .message-content table td {
    padding: 12px 15px;
    border: 1px solid #ddd;
}

.message.ai .message-content table tbody tr {
    border-bottom: 1px solid #ddd;
    transition: background-color 0.2s;
}

.message.ai .message-content table tbody tr:nth-of-type(even) {
    background-color: #f8f9fa;
}

.message.ai .message-content table tbody tr:hover {
    background-color: #e9ecef;
}

.message.ai .message-content table tbody tr:last-of-type {
    border-bottom: 2px solid #667eea;
}

/* ä»£ç å—æ ·å¼ */
.message.ai .message-content pre {
    background: #282c34;
    color: #abb2bf;
    padding: 1em;
    border-radius: 8px;
    overflow-x: auto;
    margin: 1em 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.message.ai .message-content pre code {
    background: none;
    padding: 0;
    color: inherit;
    font-size: 0.9em;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
}

/* è¡Œå†…ä»£ç æ ·å¼ */
.message.ai .message-content code {
    background: #f4f4f4;
    color: #e83e8c;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.9em;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
}

/* å¼•ç”¨æ ·å¼ */
.message.ai .message-content blockquote {
    border-left: 4px solid #007bff;
    background: #f8f9fa;
    margin: 1em 0;
    padding: 0.5em 1em;
    font-style: italic;
    color: #555;
}

/* åˆ†å‰²çº¿æ ·å¼ */
.message.ai .message-content hr {
    border: none;
    border-top: 2px solid #e9ecef;
    margin: 1.5em 0;
}

/* é“¾æ¥æ ·å¼ */
.message.ai .message-content a {
    color: #007bff;
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s;
}

.message.ai .message-content a:hover {
    border-bottom-color: #007bff;
}

/* å¼ºè°ƒæ–‡æœ¬ */
.message.ai .message-content strong {
    font-weight: 600;
    color: #333;
}

.message.ai .message-content em {
    font-style: italic;
    color: #555;
}

/* å›¾ç‰‡æ ·å¼ */
.message.ai .message-content img {
    max-width: 100%;
    border-radius: 8px;
    margin: 0.5em 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    flex-shrink: 0;
}

.message.user .message-avatar {
    background: #007bff;
    color: white;
    order: 1;
    margin-left: 10px;
}

.message.ai .message-avatar {
    background: #28a745;
    color: white;
    margin-right: 10px;
}

.session-item:hover {
    background: #e9ecef !important;
    border-color: #007bff !important;
}

.session-item.active {
    background: #007bff !important;
    color: white !important;
    border-color: #007bff !important;
}

.session-item.active div {
    color: white !important;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .page-content > div {
        grid-template-columns: 1fr !important;
        height: auto !important;
    }
    
    .sessions-sidebar {
        order: 1;
        max-height: 200px;
    }
    
    .chat-container {
        order: 0;
        height: 500px;
    }
}
</style>

<script>
let currentSessionId = null;
let isLoading = false;
let availableModels = [];
let selectedModel = null;

// åŠ è½½å¯ç”¨æ¨¡å‹åˆ—è¡¨
async function loadAvailableModels() {
    try {
        const response = await fetch('/chat/api/models/');
        const data = await response.json();
        
        if (data.success && data.models) {
            availableModels = data.models;
            const modelSelect = document.getElementById('modelSelect');
            modelSelect.innerHTML = '';
            
            data.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });
            
            // è®¾ç½®é»˜è®¤é€‰ä¸­ç¬¬äºŒä¸ªæ¨¡å‹ï¼ˆé€šä¹‰åƒé—®ï¼‰
            if (data.models.length > 1) {
                modelSelect.selectedIndex = 1;
            }
            selectedModel = modelSelect.value;
            
            // ç›‘å¬æ¨¡å‹åˆ‡æ¢
            modelSelect.addEventListener('change', function() {
                selectedModel = this.value;
                updateModelStatus(selectedModel);
            });
            
            updateModelStatus(selectedModel);
        }
    } catch (error) {
        console.error('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
        document.getElementById('modelSelect').innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
    }
}

// æ›´æ–°æ¨¡å‹çŠ¶æ€æ˜¾ç¤º
function updateModelStatus(model) {
    const statusEl = document.getElementById('modelStatus');
    if (model) {
        statusEl.textContent = `âœ“ å·²é€‰æ‹©: ${model}`;
        statusEl.style.color = '#28a745';
    } else {
        statusEl.textContent = '';
    }
}


// å‘é€æ¶ˆæ¯
async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message || isLoading) return;
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    input.value = '';
    
    // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    addMessage(message, true);
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    isLoading = true;
    const loadingMessage = addMessage('æ­£åœ¨æ€è€ƒä¸­...', false, true);
    
    try {
        const response = await fetch('/chat/api/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                message: message,
                session_id: currentSessionId,
                model: selectedModel  // æ·»åŠ æ¨¡å‹å‚æ•°
            })
        });
        
        const data = await response.json();
        
        // ç§»é™¤åŠ è½½æ¶ˆæ¯
        loadingMessage.remove();
        
        if (data.success) {
            // æ˜¾ç¤ºAIå›å¤
            addMessage(data.response, false);
            
            // æ›´æ–°å½“å‰ä¼šè¯ID
            if (data.session_id && !currentSessionId) {
                currentSessionId = data.session_id;
                // åŠ¨æ€æ·»åŠ æ–°ä¼šè¯åˆ°åˆ—è¡¨ï¼ˆä¸åˆ·æ–°é¡µé¢ï¼‰
                addSessionToList(data.session_id, message);
            }
        } else {
            addMessage('æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼š' + data.error, false);
        }
    } catch (error) {
        loadingMessage.remove();
        addMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚', false);
        console.error('Error:', error);
    } finally {
        isLoading = false;
        input.focus();
    }
}

// æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
function addMessage(content, isUser, isLoading = false) {
    const messagesContainer = document.getElementById('chatMessages');
    
    // éšè—æ¬¢è¿æ¶ˆæ¯
    const welcomeMessage = messagesContainer.querySelector('.welcome-message');
    if (welcomeMessage) {
        welcomeMessage.style.display = 'none';
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
    
    const avatarDiv = document.createElement('div');
    avatarDiv.className = 'message-avatar';
    avatarDiv.textContent = isUser ? 'ğŸ‘¤' : 'ğŸ¤–';
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    if (isLoading) {
        contentDiv.innerHTML = '<span style="opacity: 0.7;">æ­£åœ¨æ€è€ƒä¸­...</span>';
    } else if (isUser) {
        // ç”¨æˆ·æ¶ˆæ¯ï¼šçº¯æ–‡æœ¬æ˜¾ç¤º
        contentDiv.textContent = content;
    } else {
        // AIæ¶ˆæ¯ï¼šä½¿ç”¨Markdownæ¸²æŸ“
        console.log('å¼€å§‹æ¸²æŸ“Markdownï¼Œå†…å®¹é•¿åº¦:', content.length);
        console.log('å†…å®¹é¢„è§ˆ:', content.substring(0, 100));
        
        try {
            // æ£€æŸ¥markedæ˜¯å¦å¯ç”¨
            if (typeof marked === 'undefined') {
                console.error('âŒ markedåº“æœªåŠ è½½ï¼');
                contentDiv.textContent = content;
                return;
            }
            
            // é…ç½®markedé€‰é¡¹
            marked.setOptions({
                breaks: true,  // æ”¯æŒæ¢è¡Œ
                gfm: true,     // GitHubé£æ ¼Markdown
                tables: true,  // æ”¯æŒè¡¨æ ¼
                highlight: function(code, lang) {
                    // ä»£ç é«˜äº®
                    if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                        try {
                            return hljs.highlight(code, { language: lang }).value;
                        } catch (err) {
                            console.warn('ä»£ç é«˜äº®å¤±è´¥:', err);
                        }
                    }
                    return typeof hljs !== 'undefined' ? hljs.highlightAuto(code).value : code;
                }
            });
            
            // æ¸²æŸ“Markdown
            const rawHtml = marked.parse(content);
            console.log('Markdownæ¸²æŸ“å®Œæˆï¼ŒHTMLé•¿åº¦:', rawHtml.length);
            
            // ä½¿ç”¨DOMPurifyæ¸…ç†HTMLï¼Œé˜²æ­¢XSSæ”»å‡»
            if (typeof DOMPurify !== 'undefined') {
                const cleanHtml = DOMPurify.sanitize(rawHtml, {
                    ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u', 's', 'code', 'pre', 
                                  'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                                  'ul', 'ol', 'li', 'blockquote', 'hr',
                                  'table', 'thead', 'tbody', 'tr', 'th', 'td',
                                  'a', 'img', 'span', 'div'],
                    ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'style']
                });
                contentDiv.innerHTML = cleanHtml;
                console.log('âœ… HTMLå·²æ¸…ç†å¹¶æ’å…¥');
            } else {
                console.warn('âš ï¸ DOMPurifyæœªåŠ è½½ï¼Œç›´æ¥ä½¿ç”¨HTML');
                contentDiv.innerHTML = rawHtml;
            }
            
            // å¯¹ä»£ç å—åº”ç”¨é«˜äº®
            if (typeof hljs !== 'undefined') {
                contentDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
                console.log('âœ… ä»£ç é«˜äº®åº”ç”¨å®Œæˆ');
            }
        } catch (error) {
            console.error('âŒ Markdownæ¸²æŸ“é”™è¯¯:', error);
            contentDiv.textContent = content;
        }
    }
    
    messageDiv.appendChild(avatarDiv);
    messageDiv.appendChild(contentDiv);
    
    messagesContainer.appendChild(messageDiv);
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageDiv;
}

// å¤„ç†å›è½¦é”®
function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

// åˆ›å»ºæ–°ä¼šè¯
function createNewSession() {
    currentSessionId = null;
    document.getElementById('chatMessages').innerHTML = `
        <div class="welcome-message" style="text-align: center; color: #666; padding: 40px 20px;">
            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ¤–</div>
            <h3 style="margin: 0 0 10px 0;">å¼€å§‹æ–°çš„å¯¹è¯</h3>
            <p>è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œæˆ‘ä¼šå°½åŠ›ä¸ºæ‚¨è§£ç­”ã€‚</p>
        </div>
    `;
    
    // ç§»é™¤æ‰€æœ‰ä¼šè¯çš„é€‰ä¸­çŠ¶æ€
    document.querySelectorAll('.session-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // èšç„¦è¾“å…¥æ¡†
    document.getElementById('messageInput').focus();
}

// åŠ¨æ€æ·»åŠ æ–°ä¼šè¯åˆ°åˆ—è¡¨
function addSessionToList(sessionId, firstMessage) {
    const sessionsList = document.querySelector('.sessions-list');
    
    // ç§»é™¤"æš‚æ— å¯¹è¯è®°å½•"æç¤º
    const emptyMessage = sessionsList.querySelector('div[style*="text-align: center"]');
    if (emptyMessage) {
        emptyMessage.remove();
    }
    
    // åˆ›å»ºæ–°ä¼šè¯é¡¹
    const sessionItem = document.createElement('div');
    sessionItem.className = 'session-item active';
    sessionItem.dataset.sessionId = sessionId;
    sessionItem.style.cssText = 'padding: 10px; margin-bottom: 8px; background: #e3f2fd; border-radius: 5px; position: relative; border: 2px solid #007bff;';
    
    // æˆªå–æ¶ˆæ¯ä½œä¸ºæ ‡é¢˜
    const title = firstMessage.length > 30 ? firstMessage.substring(0, 27) + '...' : firstMessage;
    const fullTitle = firstMessage; // ä¿å­˜å®Œæ•´æ ‡é¢˜ç”¨äºé‡å‘½å
    
    // è·å–å½“å‰æ—¶é—´
    const now = new Date();
    const timeStr = `${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    
    sessionItem.innerHTML = `
        <div class="session-content">
            <div class="session-title" style="font-weight: 500; font-size: 14px; color: #333; margin-bottom: 2px; padding-right: 30px;">${title}</div>
            <div style="font-size: 11px; color: #666;">${timeStr}</div>
        </div>
        <div class="session-actions" style="position: absolute; top: 8px; right: 8px; display: none;">
            <button class="rename-btn" 
                    style="background: none; border: none; cursor: pointer; padding: 4px; color: #007bff; font-size: 14px;"
                    title="é‡å‘½å">
                âœï¸
            </button>
        </div>
        <div class="session-edit" style="display: none; padding: 5px 0;">
            <input type="text" class="rename-input" 
                   style="width: 100%; padding: 5px; border: 1px solid #007bff; border-radius: 3px; font-size: 14px;">
            <div style="margin-top: 5px; font-size: 11px; color: #666;">
                æŒ‰å›è½¦ä¿å­˜ï¼Œç‚¹å‡»å¤–éƒ¨å–æ¶ˆ
            </div>
        </div>
    `;
    
    // æ·»åŠ ç‚¹å‡»äº‹ä»¶ - åªåœ¨ session-content ä¸Š
    sessionItem.querySelector('.session-content').addEventListener('click', function() {
        loadSession(sessionId);
    });
    
    // æ·»åŠ é‡å‘½åæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    sessionItem.querySelector('.rename-btn').addEventListener('click', function(e) {
        e.stopPropagation();
        startRenameSession(sessionId, fullTitle);
    });
    
    // æ·»åŠ è¾“å…¥æ¡†äº‹ä»¶
    const input = sessionItem.querySelector('.rename-input');
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            saveRename(sessionId, this.value);
        }
    });
    input.addEventListener('blur', function() {
        setTimeout(() => cancelRename(sessionId), 200);
    });
    
    // ç§»é™¤å…¶ä»–ä¼šè¯çš„é€‰ä¸­çŠ¶æ€
    document.querySelectorAll('.session-item').forEach(item => {
        item.classList.remove('active');
        item.style.background = '#f8f9fa';
        item.style.border = '1px solid #e9ecef';
    });
    
    // æ’å…¥åˆ°åˆ—è¡¨é¡¶éƒ¨
    sessionsList.insertBefore(sessionItem, sessionsList.firstChild);
}

// é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // æ£€æŸ¥å¿…è¦çš„åº“æ˜¯å¦åŠ è½½
    console.log('Markedåº“åŠ è½½çŠ¶æ€:', typeof marked !== 'undefined' ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½');
    console.log('Highlight.jsåŠ è½½çŠ¶æ€:', typeof hljs !== 'undefined' ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½');
    console.log('DOMPurifyåŠ è½½çŠ¶æ€:', typeof DOMPurify !== 'undefined' ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½');
    
    // èšç„¦è¾“å…¥æ¡†
    document.getElementById('messageInput').focus();
    
    // åŠ è½½å¯ç”¨æ¨¡å‹
    loadAvailableModels();
    
    // ä¸ºä¼šè¯é¡¹çš„å†…å®¹åŒºåŸŸæ·»åŠ ç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.session-item').forEach(item => {
        const sessionId = item.dataset.sessionId;
        const sessionTitle = item.dataset.sessionTitle || '';
        
        console.log('ä¸ºä¼šè¯é¡¹ç»‘å®šäº‹ä»¶ï¼ŒID:', sessionId, 'æ ‡é¢˜:', sessionTitle);
        
        // ä¸ºå†…å®¹åŒºåŸŸæ·»åŠ ç‚¹å‡»äº‹ä»¶
        const contentDiv = item.querySelector('.session-content');
        if (contentDiv) {
            contentDiv.addEventListener('click', function(e) {
                console.log('ç‚¹å‡»ä¼šè¯å†…å®¹ï¼ŒåŠ è½½ä¼šè¯:', sessionId);
                loadSession(sessionId);
            });
        }
        
        // ä¸ºé‡å‘½åæŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
        const renameBtn = item.querySelector('.rename-btn');
        if (renameBtn) {
            console.log('æ‰¾åˆ°é‡å‘½åæŒ‰é’®ï¼Œç»‘å®šäº‹ä»¶');
            renameBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                e.preventDefault();
                console.log('ç‚¹å‡»é‡å‘½åæŒ‰é’®ï¼Œä¼šè¯ID:', sessionId, 'å½“å‰æ ‡é¢˜:', sessionTitle);
                startRenameSession(sessionId, sessionTitle);
            });
        } else {
            console.warn('æœªæ‰¾åˆ°é‡å‘½åæŒ‰é’®ï¼Œä¼šè¯ID:', sessionId);
        }
        
        // ä¸ºè¾“å…¥æ¡†æ·»åŠ äº‹ä»¶
        const input = item.querySelector('.rename-input');
        if (input) {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveRename(sessionId, this.value);
                }
            });
            input.addEventListener('blur', function() {
                setTimeout(() => cancelRename(sessionId), 200);
            });
        }
    });
});

// åŠ è½½æŒ‡å®šä¼šè¯
async function loadSession(sessionId) {
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">åŠ è½½ä¸­...</div>';
        
        // è¯·æ±‚ä¼šè¯å†å²
        const response = await fetch(`/chat/history/${sessionId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // æ›´æ–°å½“å‰ä¼šè¯ID
            currentSessionId = sessionId;
            
            // æ¸…ç©ºæ¶ˆæ¯å®¹å™¨
            messagesContainer.innerHTML = '';
            
            // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæ¬¢è¿æç¤º
            if (!data.messages || data.messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="welcome-message" style="text-align: center; color: #666; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ¤–</div>
                        <h3 style="margin: 0 0 10px 0;">å¼€å§‹å¯¹è¯</h3>
                        <p>è¿™æ˜¯ä¸€ä¸ªæ–°çš„ä¼šè¯ï¼Œè¯·è¾“å…¥æ‚¨çš„é—®é¢˜ã€‚</p>
                    </div>
                `;
            } else {
                // æ¸²æŸ“å†å²æ¶ˆæ¯
                data.messages.forEach(msg => {
                    addMessage(msg.content, msg.is_user);
                });
            }
            
            // æ›´æ–°UIçŠ¶æ€ - é«˜äº®å½“å‰ä¼šè¯
            document.querySelectorAll('.session-item').forEach(item => {
                item.classList.remove('active');
                item.style.background = '#f8f9fa';
                item.style.border = '1px solid #e9ecef';
            });
            
            const activeSession = document.querySelector(`[data-session-id="${sessionId}"]`);
            if (activeSession) {
                activeSession.classList.add('active');
                activeSession.style.background = '#e3f2fd';
                activeSession.style.border = '2px solid #007bff';
            }
            
            // èšç„¦è¾“å…¥æ¡†
            document.getElementById('messageInput').focus();
        } else {
            messagesContainer.innerHTML = `
                <div style="text-align: center; color: #dc3545; padding: 40px 20px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">âŒ</div>
                    <h3 style="margin: 0 0 10px 0;">åŠ è½½å¤±è´¥</h3>
                    <p>${data.error || 'æ— æ³•åŠ è½½ä¼šè¯å†å²'}</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('åŠ è½½ä¼šè¯å¤±è´¥:', error);
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML = `
            <div style="text-align: center; color: #dc3545; padding: 40px 20px;">
                <div style="font-size: 48px; margin-bottom: 20px;">âŒ</div>
                <h3 style="margin: 0 0 10px 0;">ç½‘ç»œé”™è¯¯</h3>
                <p>æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·ç¨åå†è¯•ã€‚</p>
            </div>
        `;
    }
}

// å¼€å§‹é‡å‘½åä¼šè¯
function startRenameSession(sessionId, currentTitle) {
    console.log('å¼€å§‹é‡å‘½åä¼šè¯ï¼ŒID:', sessionId, 'å½“å‰æ ‡é¢˜:', currentTitle);
    
    const sessionItem = document.querySelector(`[data-session-id="${sessionId}"]`);
    if (!sessionItem) {
        console.error('æœªæ‰¾åˆ°ä¼šè¯é¡¹ï¼ŒID:', sessionId);
        return;
    }
    
    console.log('æ‰¾åˆ°ä¼šè¯é¡¹:', sessionItem);
    
    const contentDiv = sessionItem.querySelector('.session-content');
    const editDiv = sessionItem.querySelector('.session-edit');
    const input = sessionItem.querySelector('.rename-input');
    
    console.log('content div:', contentDiv);
    console.log('edit div:', editDiv);
    console.log('input:', input);
    
    if (!contentDiv || !editDiv || !input) {
        console.error('æœªæ‰¾åˆ°å¿…è¦çš„å…ƒç´ ');
        return;
    }
    
    // éšè—å†…å®¹ï¼Œæ˜¾ç¤ºç¼–è¾‘æ¡†
    contentDiv.style.display = 'none';
    editDiv.style.display = 'block';
    
    // è®¾ç½®å½“å‰æ ‡é¢˜å¹¶é€‰ä¸­
    input.value = currentTitle;
    input.focus();
    input.select();
    
    console.log('ç¼–è¾‘æ¨¡å¼å·²æ¿€æ´»');
}

// ä¿å­˜é‡å‘½å
async function saveRename(sessionId, newTitle) {
    newTitle = newTitle.trim();
    
    if (!newTitle) {
        alert('æ ‡é¢˜ä¸èƒ½ä¸ºç©º');
        cancelRename(sessionId);
        return;
    }
    
    try {
        const response = await fetch(`/chat/rename/${sessionId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ title: newTitle })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // æ›´æ–°UIæ˜¾ç¤º
            const sessionItem = document.querySelector(`[data-session-id="${sessionId}"]`);
            const titleDiv = sessionItem.querySelector('.session-title');
            titleDiv.textContent = newTitle.length > 30 ? newTitle.substring(0, 27) + '...' : newTitle;
            
            // éšè—ç¼–è¾‘æ¡†ï¼Œæ˜¾ç¤ºå†…å®¹
            cancelRename(sessionId);
        } else {
            alert('é‡å‘½åå¤±è´¥: ' + data.error);
            cancelRename(sessionId);
        }
    } catch (error) {
        console.error('é‡å‘½åå¤±è´¥:', error);
        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•');
        cancelRename(sessionId);
    }
}

// å–æ¶ˆé‡å‘½å
function cancelRename(sessionId) {
    const sessionItem = document.querySelector(`[data-session-id="${sessionId}"]`);
    if (!sessionItem) return;
    
    const contentDiv = sessionItem.querySelector('.session-content');
    const editDiv = sessionItem.querySelector('.session-edit');
    
    // æ˜¾ç¤ºå†…å®¹ï¼Œéšè—ç¼–è¾‘æ¡†
    contentDiv.style.display = 'block';
    editDiv.style.display = 'none';
}
</script>
{% endblock %}
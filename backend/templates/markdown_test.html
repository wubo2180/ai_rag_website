<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Markdown渲染测试</title>
    <!-- Markdown渲染库 - 使用多个CDN源作为备选 -->
    <script src="https://unpkg.com/marked@11.1.1/marked.min.js" 
            onerror="this.onerror=null; this.src='https://cdn.bootcdn.net/ajax/libs/marked/11.1.1/marked.min.js'"></script>
    <!-- 代码高亮库 -->
    <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/styles/github.min.css" 
          onerror="this.onerror=null; this.href='https://cdn.bootcdn.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css'">
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js"
            onerror="this.onerror=null; this.src='https://cdn.bootcdn.net/ajax/libs/highlight.js/11.9.0/highlight.min.js'"></script>
    <!-- DOMPurify - 防止XSS攻击 -->
    <script src="https://unpkg.com/dompurify@3.0.6/dist/purify.min.js"
            onerror="this.onerror=null; this.src='https://cdn.bootcdn.net/ajax/libs/dompurify/3.0.6/purify.min.js'"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
        }
        #output {
            background: #f1f3f4;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        table thead tr {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        table th, table td {
            padding: 12px 15px;
            border: 1px solid #ddd;
        }
        table tbody tr:nth-of-type(even) {
            background-color: #f8f9fa;
        }
        pre {
            background: #282c34;
            color: #abb2bf;
            padding: 1em;
            border-radius: 8px;
            overflow-x: auto;
        }
        code {
            background: #f4f4f4;
            color: #e83e8c;
            padding: 2px 6px;
            border-radius: 4px;
        }
        pre code {
            background: none;
            color: inherit;
            padding: 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>🧪 Markdown渲染测试</h1>
    
    <div id="status"></div>
    
    <button onclick="testTable()">测试表格</button>
    <button onclick="testCode()">测试代码</button>
    <button onclick="testMixed()">测试混合格式</button>
    
    <div id="output"></div>

    <script>
        // 检查库是否加载
        window.addEventListener('load', function() {
            let status = '<div class="status success">';
            let allLoaded = true;
            
            if (typeof marked !== 'undefined') {
                status += '✅ marked.js 已加载<br>';
            } else {
                status += '❌ marked.js 未加载<br>';
                allLoaded = false;
            }
            
            if (typeof hljs !== 'undefined') {
                status += '✅ highlight.js 已加载<br>';
            } else {
                status += '❌ highlight.js 未加载<br>';
                allLoaded = false;
            }
            
            if (typeof DOMPurify !== 'undefined') {
                status += '✅ DOMPurify 已加载<br>';
            } else {
                status += '❌ DOMPurify 未加载<br>';
                allLoaded = false;
            }
            
            status += '</div>';
            document.getElementById('status').innerHTML = status;
            
            if (allLoaded) {
                console.log('所有库已成功加载');
                // 配置marked
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    tables: true,
                    highlight: function(code, lang) {
                        if (lang && hljs.getLanguage(lang)) {
                            return hljs.highlight(code, { language: lang }).value;
                        }
                        return hljs.highlightAuto(code).value;
                    }
                });
            }
        });
        
        function render(markdown) {
            console.log('渲染Markdown:', markdown.substring(0, 100));
            const output = document.getElementById('output');
            
            try {
                const rawHtml = marked.parse(markdown);
                console.log('生成HTML:', rawHtml.substring(0, 100));
                
                const cleanHtml = DOMPurify.sanitize(rawHtml);
                output.innerHTML = cleanHtml;
                
                output.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
                
                console.log('✅ 渲染成功');
            } catch (error) {
                console.error('❌ 渲染失败:', error);
                output.textContent = '渲染失败: ' + error.message;
            }
        }
        
        function testTable() {
            const markdown = `
## 📊 测试表格

| 列1 | 列2 | 列3 |
|-----|-----|-----|
| A   | B   | C   |
| D   | E   | F   |
| G   | H   | I   |
            `;
            render(markdown);
        }
        
        function testCode() {
            const markdown = `
## 💻 测试代码

\`\`\`python
def hello():
    print("Hello, World!")
    return True
\`\`\`

行内代码：\`const x = 10;\`
            `;
            render(markdown);
        }
        
        function testMixed() {
            const markdown = `
# 完整测试

## 表格
| 名称 | 数值 |
|------|------|
| A    | 100  |
| B    | 200  |

## 代码
\`\`\`javascript
console.log('test');
\`\`\`

## 列表
1. 第一项
2. 第二项

**粗体** 和 *斜体*
            `;
            render(markdown);
        }
    </script>
</body>
</html>

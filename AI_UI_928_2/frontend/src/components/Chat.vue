<!--  --><template>
  <div id="chat-container">
    <!-- Sidebar -->
    <div class="sidebar" :class="{ collapsed: sidebarCollapsed }">
      <div class="sidebar-header">
        <button class="menu-toggle" @click="toggleSidebar">
          <span class="hamburger-icon">
            <span></span>
            <span></span>
            <span></span>
          </span>
        </button>
        <h2 v-if="!sidebarCollapsed" class="sidebar-title">iBox Materix</h2>
        <button v-if="!sidebarCollapsed" class="logout-btn" @click="logout" title="ÈÄÄÂá∫ÁôªÂΩï">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
        </button>
      </div>
      <button v-if="!sidebarCollapsed" class="new-chat-btn" @click="startNewChat">
        <span class="btn-icon">+</span>
        ÂºÄÂêØÊñ∞ÂØπËØù
      </button>
      <div v-if="!sidebarCollapsed" class="history">
        <h3>ÂØπËØùÂéÜÂè≤</h3>
        <ul>
          <li v-for="(chat, index) in chatHistory" :key="index" :class="{ active: currentChatIndex === index }" class="chat-item">
            <div class="chat-content" @click="loadChat(index)">
              <span class="chat-icon">üí¨</span>
              <span class="chat-title">{{ chat.title || `ÂØπËØù ${chatHistory.length - index}` }}</span>
            </div>
            <button class="delete-btn" @click.stop="deleteChat(index)" title="Âà†Èô§ÂØπËØù">
              üóëÔ∏è
            </button>
          </li>
        </ul>
      </div>
      <div v-if="sidebarCollapsed" class="collapsed-actions">
        <button class="collapsed-new-chat" @click="startNewChat" title="Êñ∞Âª∫ÂØπËØù">
          <span>+</span>
        </button>
      </div>
    </div>

    <!-- Main Chat -->
    <div class="main-chat">
      <div class="chat-header">
        <div class="user-info">
          <span class="user-avatar">üë§</span>
          <span class="user-name">{{ currentUser.username }}</span>
        </div>
      </div>
      
      <div class="messages-container" ref="messagesContainer">
        <div v-if="messages.length === 0" class="welcome-message">
          <span class="hello-emoji">üëã</span>
          <p>ÊÇ®Â•Ω {{ currentUser.username }}ÔºåÊÉ≥ÂíåÊàëËÅäÁÇπ‰ªÄ‰πàÔºü</p>
        </div>
        <div v-for="(msg, index) in messages" :key="index" class="message" :class="msg.sender">
          <div class="bubble">
            <p v-if="msg.text || !isLoading || msg.sender !== 'ai' || index !== messages.length - 1">{{ msg.text }}</p>
            <p v-else-if="isLoading && msg.sender === 'ai' && index === messages.length - 1">Ê≠£Âú®ÊÄùËÄÉ‰∏≠...</p>
            <div v-if="msg.sender === 'ai' && (msg.text || (!isLoading || index !== messages.length - 1))" class="message-actions">
              <button class="action-btn copy-btn" @click="copyMessage(msg.text)" title="Â§çÂà∂">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
              </button>
              <button class="action-btn like-btn" @click="likeMessage" title="Ëµû">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
                </svg>
              </button>
              <button class="action-btn dislike-btn" @click="dislikeMessage" title="Ë∏©">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"></path>
                </svg>
              </button>
              <button class="action-btn refresh-btn" @click="refreshMessage" title="ÈáçÊñ∞ÁîüÊàê">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="23 4 23 10 17 10"></polyline>
                  <polyline points="1 20 1 14 7 14"></polyline>
                  <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                </svg>
              </button>
              <button class="action-btn more-btn" @click="showMoreOptions" title="Êõ¥Â§ö">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="1"></circle>
                  <circle cx="19" cy="12" r="1"></circle>
                  <circle cx="5" cy="12" r="1"></circle>
                </svg>
              </button>
            </div>
          </div>
        </div>
        <!-- Related Questions - ÊòæÁ§∫Âú®ÊúÄÂêé‰∏ÄÊù°AIÊ∂àÊÅØÂêé -->
        <div v-if="messages.length > 0 && messages[messages.length - 1].sender === 'ai' && relatedQuestions.length > 0" class="related-questions">
          <div class="related-questions-title">üí° Áõ∏ÂÖ≥ÈóÆÈ¢òÊé®ËçêÔºö</div>
          <div class="related-questions-list">
            <div 
              v-for="(question, index) in relatedQuestions" 
              :key="index" 
              class="related-question-item" 
              @click="askRelatedQuestion(question)"
            >
              <span class="question-text">{{ question }}</span>
            </div>
          </div>
        </div>

        <!-- ÊªöÂä®Âà∞Â∫ïÈÉ®ÊåâÈíÆ -->
        <div v-if="!isAtBottom && messages.length > 0" class="scroll-to-bottom-btn" @click="scrollToBottomManually">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="7 13 12 18 17 13"></polyline>
            <polyline points="7 6 12 11 17 6"></polyline>
          </svg>
        </div>

      </div>

      <!-- Chat Input Area -->
      <div class="chat-input-area">
        <!-- Suggestions List -->
        <div v-if="suggestions.length > 0" class="suggestions-list">
          <ul>
            <li 
              v-for="(suggestion, index) in suggestions" 
              :key="index" 
              :class="{ selected: index === selectedIndex }"
              @mousedown.prevent="selectSuggestion(suggestion)"
            >
              <span v-html="highlightQuery(suggestion)"></span>
            </li>
          </ul>
        </div>
        <!-- Input Wrapper -->
        <div class="input-wrapper">
          <div class="textarea-container">
            <textarea 
              ref="messageTextarea"
              v-model="newMessage" 
              @keydown="handleKeydown"
              @input="handleInput"
              @focus="fetchSuggestions"
              @blur="clearSuggestions"
              placeholder="ËØ¢ÈóÆAI‰ªª‰ΩïÈóÆÈ¢ò" 
              rows="2"
            ></textarea>
          </div>
          <button @click="sendMessage" class="send-btn">‚Üë</button>
        </div>
        <!-- Button Layer -->
        <div class="button-layer">
          <div class="database-selector" :class="{ open: dropdownOpen }">
            <button class="db-selector-btn" @click="toggleDropdown">
              <span class="db-text">{{ getCurrentDatabaseOption().label }}</span>
              <span class="dropdown-arrow">‚ñº</span>
            </button>
            <div v-if="dropdownOpen" class="dropdown-menu">
              <div 
                v-for="option in databaseOptions" 
                :key="option.value"
                @click="selectDatabase(option.value)"
                :class="['dropdown-item', { active: selectedDatabase === option.value }]"
              >
                <span class="db-label">{{ option.label }}</span>
              </div>
            </div>
          </div>
          
          <!-- Ê∑±Â∫¶ÊÄùËÄÉÊåâÈíÆ -->
          <button 
            class="deep-thinking-btn" 
            :class="{ active: deepThinkingEnabled }"
            @click="toggleDeepThinking"
            title="Ê∑±Â∫¶ÊÄùËÄÉ"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 12l2 2 4-4"></path>
              <path d="M21 12c.552 0 1-.448 1-1s-.448-1-1-1-1 .448-1 1 .448 1 1 1z"></path>
              <path d="M3 12c.552 0 1-.448 1-1s-.448-1-1-1-1 .448-1 1 .448 1 1 1z"></path>
              <path d="M12 21c.552 0 1-.448 1-1s-.448-1-1-1-1 .448-1 1 .448 1 1 1z"></path>
              <path d="M12 3c.552 0 1-.448 1-1s-.448-1-1-1-1 .448-1 1 .448 1 1 1z"></path>
            </svg>
            <span class="btn-text">Ê∑±Â∫¶ÊêúÁ¥¢</span>
          </button>
          
          <!-- Ê®°ÂûãÈÄâÊã©ÊåâÈíÆ -->
          <div class="model-selector" :class="{ open: modelDropdownOpen }">
            <button class="model-selector-btn" @click="toggleModelDropdown">
              <span class="model-text">{{ getCurrentModelOption().label }}</span>
              <span class="dropdown-arrow">‚ñº</span>
            </button>
            <div v-if="modelDropdownOpen" class="dropdown-menu">
              <div 
                v-for="option in modelOptions" 
                :key="option.value"
                @click="selectModel(option.value)"
                :class="['dropdown-item', { active: selectedModel === option.value }]"
              >
                <span class="model-label">{{ option.label }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, nextTick, onMounted, onUnmounted } from 'vue';
import { useRouter } from 'vue-router';
import axios from 'axios';

const router = useRouter();

// Ëé∑ÂèñÂΩìÂâçÁî®Êà∑‰ø°ÊÅØ
const currentUser = ref({});

// Refs for UI elements and state
const newMessage = ref('');
const messages = ref([]);
const chatHistory = ref([]);
const isLoading = ref(false);
const messagesContainer = ref(null);
const messageTextarea = ref(null);
const currentChatIndex = ref(-1);
const currentChatTitle = ref('');
const sidebarCollapsed = ref(false);

// Êñ∞Â¢ûÔºöÂØπËØùÁä∂ÊÄÅÁÆ°ÁêÜ
const currentChatId = ref(null); // ÂΩìÂâçÂØπËØùÁöÑÂîØ‰∏ÄID
const isNewChat = ref(true); // Ê†áËØÜÂΩìÂâçÊòØÂê¶‰∏∫Êñ∞ÂØπËØù

// --- LocalStorage Functions ---
const getUserStorageKey = () => {
  const user = JSON.parse(localStorage.getItem('ai-chat-user') || '{}');
  return `ai-chat-history-${user.username || 'anonymous'}`;
};

const loadFromStorage = () => {
  try {
    const storageKey = getUserStorageKey();
    const stored = localStorage.getItem(storageKey);
    if (stored) {
      const data = JSON.parse(stored);
      chatHistory.value = data.chatHistory || [];
      messages.value = data.currentMessages || [];
      currentChatIndex.value = data.currentChatIndex || -1;
      currentChatTitle.value = data.currentChatTitle || '';
      currentChatId.value = data.currentChatId || null;
      isNewChat.value = data.isNewChat !== undefined ? data.isNewChat : true;
      relatedQuestions.value = data.currentRelatedQuestions || [];
    }
  } catch (error) {
    console.error('Âä†ËΩΩÊú¨Âú∞Â≠òÂÇ®Â§±Ë¥•:', error);
  }
};

const saveToStorage = () => {
  try {
    const storageKey = getUserStorageKey();
    const data = {
      chatHistory: chatHistory.value,
      currentMessages: messages.value,
      currentChatIndex: currentChatIndex.value,
      currentChatTitle: currentChatTitle.value,
      currentChatId: currentChatId.value,
      isNewChat: isNewChat.value,
      currentRelatedQuestions: relatedQuestions.value
    };
    localStorage.setItem(storageKey, JSON.stringify(data));
  } catch (error) {
    console.error('‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®Â§±Ë¥•:', error);
  }
};

// Database selector state
const selectedDatabase = ref('all');
const dropdownOpen = ref(false);
const databaseOptions = ref([
  { value: 'external', label: 'Â§ñÈÉ®Êï∞ÊçÆÂ∫ì' },
  { value: 'internal', label: 'ÂÜÖÈÉ®Êï∞ÊçÆÂ∫ì' },
  { value: 'all', label: 'ÂÖ®ÈÉ®' }
]);

// Deep thinking state
const deepThinkingEnabled = ref(true);

// Model selector state
const selectedModel = ref('deepseek');
const modelDropdownOpen = ref(false);
const modelOptions = ref([
  { value: 'deepseek', label: 'DeepSeek' },
  { value: 'doubao', label: 'Ë±ÜÂåÖ' },
  { value: 'gpt5', label: 'GPT-5' }
]);

// Suggestions state
const suggestions = ref([]);
const debounceTimer = ref(null);
const selectedIndex = ref(-1);
const relatedQuestions = ref([]);

// ÊªöÂä®Áä∂ÊÄÅ
const isAtBottom = ref(true);

// --- Auth Functions ---
const logout = () => {
  if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü')) {
    // ‰øùÂ≠òÂΩìÂâçÁî®Êà∑ÁöÑÂØπËØùËÆ∞ÂΩï
    saveToStorage();
    // Âè™ÁßªÈô§Áî®Êà∑ÁôªÂΩï‰ø°ÊÅØÔºå‰øùÁïôÂØπËØùÂéÜÂè≤
    localStorage.removeItem('ai-chat-user');
    router.push('/login');
  }
};

// --- Core Functions ---

// Êô∫ËÉΩÊªöÂä®ÔºöÂè™ÊúâÂΩìÁî®Êà∑Âú®Â∫ïÈÉ®Êó∂ÊâçËá™Âä®ÊªöÂä®
const scrollToBottom = (force = false) => {
  nextTick(() => {
    if (messagesContainer.value) {
      const container = messagesContainer.value;
      const isAtBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 50;
      
      // Âº∫Âà∂ÊªöÂä®ÊàñÁî®Êà∑Âú®Â∫ïÈÉ®Êó∂ÊâçÊªöÂä®
      if (force || isAtBottom) {
        container.scrollTop = container.scrollHeight;
      }
    }
  });
};

// Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Âú®Â∫ïÈÉ®
const isUserAtBottom = () => {
  if (!messagesContainer.value) return true;
  const container = messagesContainer.value;
  return container.scrollTop + container.clientHeight >= container.scrollHeight - 50;
};

// ÁõëÂê¨ÊªöÂä®‰∫ã‰ª∂ÔºåÊõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
const handleScroll = () => {
  isAtBottom.value = isUserAtBottom();
};

// ÊâãÂä®ÊªöÂä®Âà∞Â∫ïÈÉ®
const scrollToBottomManually = () => {
  scrollToBottom(true);
  isAtBottom.value = true;
};

const sendMessage = async () => {
  if (newMessage.value.trim() === '') return;

  const userMessage = { text: newMessage.value, sender: 'user' };
  const messageToSend = newMessage.value;
  
  // Â¶ÇÊûúÊòØÊñ∞ÂØπËØùÁöÑÁ¨¨‰∏ÄÊù°Ê∂àÊÅØÔºåËÆæÁΩÆÊ†áÈ¢ò
  if (isNewChat.value && messages.value.length === 0) {
    currentChatTitle.value = messageToSend.length > 20 ? messageToSend.substring(0, 20) + '...' : messageToSend;
  }
  
  messages.value.push(userMessage);
  
  newMessage.value = '';
  suggestions.value = []; // Clear suggestions on send
  relatedQuestions.value = []; // Clear previous related questions
  isLoading.value = true;
  nextTick(adjustTextareaHeight);
  scrollToBottom();

  // Ê∑ªÂä†‰∏Ä‰∏™Á©∫ÁöÑAIÊ∂àÊÅØÁî®‰∫éÊµÅÂºèÊõ¥Êñ∞
  const aiMessageIndex = messages.value.length;
  messages.value.push({ text: '', sender: 'ai' });

  try {
    // Âπ∂Ë°åÂêØÂä®Áõ∏ÂÖ≥ÈóÆÈ¢òËé∑ÂèñÔºå‰∏çÁ≠âÂæÖAIÂõûÂ§çÂÆåÊàê
    const relatedQuestionsPromise = (async () => {
      try {
        console.log('ÂºÄÂßãËé∑ÂèñÁõ∏ÂÖ≥ÈóÆÈ¢òÔºåÊ∂àÊÅØ:', messageToSend);
        const relatedResponse = await fetch('http://127.0.0.1:5000/api/related-questions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: messageToSend,
          }),
        });
        
        console.log('Áõ∏ÂÖ≥ÈóÆÈ¢òAPIÂìçÂ∫îÁä∂ÊÄÅ:', relatedResponse.status);
        if (relatedResponse.ok) {
          const relatedData = await relatedResponse.json();
          console.log('Ëé∑ÂèñÂà∞ÁöÑÁõ∏ÂÖ≥ÈóÆÈ¢òÊï∞ÊçÆ:', relatedData);
          relatedQuestions.value = relatedData.related_questions || [];
          console.log('ËÆæÁΩÆÁöÑÁõ∏ÂÖ≥ÈóÆÈ¢ò:', relatedQuestions.value);
          scrollToBottom(); // ÊòæÁ§∫Áõ∏ÂÖ≥ÈóÆÈ¢òÂêéÈáçÊñ∞ÊªöÂä®
        }
      } catch (relatedError) {
        console.warn('Ëé∑ÂèñÁõ∏ÂÖ≥ÈóÆÈ¢òÂ§±Ë¥•:', relatedError);
      }
    })();

    // ‰ΩøÁî® fetch ËøõË°åÊµÅÂºèËØ∑Ê±Ç
    const response = await fetch('http://127.0.0.1:5000/api/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: messageToSend,
        database: selectedDatabase.value,
        model: selectedModel.value,
        deep_thinking: deepThinkingEnabled.value,
      }),
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    // Ëé∑ÂèñÂèØËØªÊï∞ÊçÆÊµÅËØªÂèñÂô®
    const reader = response.body.getReader();
    // ÂàõÂª∫‰∏Ä‰∏™ÊñáÊú¨Ëß£Á†ÅÂô®Êù•Â§ÑÁêÜ UTF-8 ÁºñÁ†ÅÁöÑÊï∞ÊçÆ
    const decoder = new TextDecoder();
    
    let aiResponse = '';
    
    // Êó†ÈôêÂæ™ÁéØÊù•ÊåÅÁª≠ËØªÂèñÊï∞ÊçÆÊµÅ
    while (true) {
      // ËØªÂèñ‰∏ÄÂùóÊï∞ÊçÆ { done, value }
      const { done, value } = await reader.read();
      
      // Â¶ÇÊûúÊï∞ÊçÆÊµÅÁªìÊùü (done is true)ÔºåÂ∞±Ë∑≥Âá∫Âæ™ÁéØ
      if (done) {
        break;
      }
      
      // Â∞ÜÊé•Êî∂Âà∞ÁöÑÊï∞ÊçÆÂùó (Uint8Array) Ëß£Á†ÅÊàêÂ≠óÁ¨¶‰∏≤
      const chunk = decoder.decode(value, { stream: true });
      
      // Â§ÑÁêÜÊúçÂä°Âô®ÂèëÈÄÅ‰∫ã‰ª∂ (SSE) Ê†ºÂºèÁöÑÊï∞ÊçÆ
      const lines = chunk.split('\n');
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6); // ÁßªÈô§ 'data: ' ÂâçÁºÄ
          if (data === '[DONE]') {
            break;
          }
          try {
            const parsed = JSON.parse(data);
            if (parsed.content) {
              aiResponse += parsed.content;
              // ÂÆûÊó∂Êõ¥Êñ∞ Vue ÁöÑ ref ÂèòÈáèÔºåUI ‰ºöËá™Âä®ÂìçÂ∫î
              messages.value[aiMessageIndex].text = aiResponse;
              scrollToBottom(); // Êô∫ËÉΩÊªöÂä®ÔºåÂè™ÊúâÁî®Êà∑Âú®Â∫ïÈÉ®Êó∂ÊâçÊªöÂä®
            }
          } catch (e) {
            // Â¶ÇÊûú‰∏çÊòØJSONÊ†ºÂºèÔºåÁõ¥Êé•Ê∑ªÂä†ÊñáÊú¨
            aiResponse += data;
            messages.value[aiMessageIndex].text = aiResponse;
            scrollToBottom(); // Êô∫ËÉΩÊªöÂä®
          }
        }
      }
    }
    
    
  } catch (error) {
    console.error('Error sending message:', error);
    messages.value[aiMessageIndex].text = 'Êä±Ê≠âÔºåÊàëÊöÇÊó∂Êó†Ê≥ïÂõûÂ§ç„ÄÇËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÁ®çÂêéÈáçËØï„ÄÇ';
  } finally {
    isLoading.value = false;
    // ‰ΩøÁî®Áªü‰∏ÄÁöÑ‰øùÂ≠òÂáΩÊï∞
    saveCurrentChat();
    scrollToBottom();
    

  }
};

// --- Sidebar and Chat History ---

const toggleSidebar = () => {
  sidebarCollapsed.value = !sidebarCollapsed.value;
};

const saveCurrentChat = () => {
  // Âè™ÊúâÂΩìÊúâÊ∂àÊÅØÂÜÖÂÆπÊó∂Êâç‰øùÂ≠ò
  if (messages.value.length === 0) return;
  
  const chatData = {
    id: currentChatId.value || Date.now(), // ‰ΩøÁî®Áé∞ÊúâIDÊàñÁîüÊàêÊñ∞ID
    messages: [...messages.value],
    title: currentChatTitle.value || (messages.value[0]?.text.substring(0, 20) + '...' || 'Êñ∞ÂØπËØù'),
    relatedQuestions: [...relatedQuestions.value],
    timestamp: new Date().toISOString()
  };
  
  if (isNewChat.value) {
    // Êñ∞ÂØπËØùÔºöÊ∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩïÂºÄÂ§¥
    chatHistory.value.unshift(chatData);
    currentChatIndex.value = 0;
    currentChatId.value = chatData.id;
    isNewChat.value = false; // Ê†áËÆ∞‰∏∫Â∑≤‰øùÂ≠òÁöÑÂØπËØù
  } else {
    // Â∑≤Â≠òÂú®ÁöÑÂØπËØùÔºöÊõ¥Êñ∞ÂØπÂ∫î‰ΩçÁΩÆÁöÑËÆ∞ÂΩï
    if (currentChatIndex.value >= 0 && currentChatIndex.value < chatHistory.value.length) {
      chatHistory.value[currentChatIndex.value] = chatData;
    }
  }
  
  saveToStorage();
};

const startNewChat = () => {
  // Â¶ÇÊûúÂΩìÂâçÊúâÂØπËØùÂÜÖÂÆπÔºå‰øùÂ≠òÂÆÉ
  if (messages.value.length > 0) {
    saveCurrentChat();
  }
  
  // ÈáçÁΩÆ‰∏∫Êñ∞ÂØπËØùÁä∂ÊÄÅ
  messages.value = [];
  currentChatIndex.value = -1;
  currentChatTitle.value = '';
  currentChatId.value = null;
  isNewChat.value = true; // Ê†áËÆ∞‰∏∫Êñ∞ÂØπËØù
  relatedQuestions.value = [];
  
  saveToStorage();
};

const loadChat = (index) => {
  // Â¶ÇÊûúÂΩìÂâçÊúâÂØπËØùÂÜÖÂÆπ‰∏îÊòØÊñ∞ÂØπËØùÔºåÂÖà‰øùÂ≠ò
  if (messages.value.length > 0 && isNewChat.value) {
    saveCurrentChat();
  }
  
  // Âä†ËΩΩÊåáÂÆöÁöÑÂéÜÂè≤ÂØπËØù
  const chatData = chatHistory.value[index];
  messages.value = [...chatData.messages];
  currentChatTitle.value = chatData.title;
  currentChatIndex.value = index;
  currentChatId.value = chatData.id;
  isNewChat.value = false; // Ê†áËÆ∞‰∏∫Â∑≤Â≠òÂú®ÁöÑÂØπËØù
  relatedQuestions.value = [...(chatData.relatedQuestions || [])];
  
  saveToStorage();
  scrollToBottom();
};

const deleteChat = (index) => {
  // Âà†Èô§ÊåáÂÆöÁöÑÂØπËØùËÆ∞ÂΩï
  chatHistory.value.splice(index, 1);
  
  // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÂØπËØù
  if (currentChatIndex.value === index) {
    // Ê∏ÖÁ©∫ÂΩìÂâçÂØπËØù
    messages.value = [];
    currentChatTitle.value = '';
    currentChatIndex.value = -1;
    relatedQuestions.value = [];
  } else if (currentChatIndex.value > index) {
    // Â¶ÇÊûúÂΩìÂâçÂØπËØùÁ¥¢ÂºïÂ§ß‰∫éÂà†Èô§ÁöÑÁ¥¢ÂºïÔºåÈúÄË¶ÅË∞ÉÊï¥Á¥¢Âºï
    currentChatIndex.value--;
  }
  
  // ‰øùÂ≠òÂà∞localStorage
  saveToStorage();
};

const copyMessage = async (text) => {
  try {
    await navigator.clipboard.writeText(text);
    showCopyToast('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
  } catch (err) {
    // Â¶ÇÊûúÁé∞‰ª£API‰∏çÂèØÁî®Ôºå‰ΩøÁî®‰º†ÁªüÊñπÊ≥ï
    const textArea = document.createElement('textarea');
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    try {
      document.execCommand('copy');
      showCopyToast('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
    } catch (fallbackErr) {
      console.error('Â§çÂà∂Â§±Ë¥•:', fallbackErr);
      showCopyToast('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
    }
    document.body.removeChild(textArea);
  }
};

// ÊòæÁ§∫Â§çÂà∂ÊèêÁ§∫
const showCopyToast = (message) => {
  // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÊèêÁ§∫
  const existingToast = document.querySelector('.copy-toast');
  if (existingToast) {
    existingToast.remove();
  }

  // ÂàõÂª∫Êñ∞ÁöÑÊèêÁ§∫ÂÖÉÁ¥†
  const toast = document.createElement('div');
  toast.className = 'copy-toast';
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 10000;
    animation: fadeInOut 2s ease-in-out;
  `;

  // Ê∑ªÂä†CSSÂä®Áîª
  if (!document.querySelector('#copy-toast-style')) {
    const style = document.createElement('style');
    style.id = 'copy-toast-style';
    style.textContent = `
      @keyframes fadeInOut {
        0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      }
    `;
    document.head.appendChild(style);
  }

  document.body.appendChild(toast);

  // 2ÁßíÂêéËá™Âä®ÁßªÈô§
  setTimeout(() => {
    if (toast.parentNode) {
      toast.parentNode.removeChild(toast);
    }
  }, 2000);
};

const likeMessage = () => {
  console.log('ÁÇπËµûÊ∂àÊÅØ');
  // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÁÇπËµûÈÄªËæë
};

const dislikeMessage = () => {
  console.log('Ë∏©Ê∂àÊÅØ');
  // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†Ë∏©ÁöÑÈÄªËæë
};

const refreshMessage = () => {
  console.log('ÈáçÊñ∞ÁîüÊàêÊ∂àÊÅØ');
  // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÈáçÊñ∞ÁîüÊàêÊ∂àÊÅØÁöÑÈÄªËæë
};

const showMoreOptions = () => {
  console.log('ÊòæÁ§∫Êõ¥Â§öÈÄâÈ°π');
  // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†Êõ¥Â§öÈÄâÈ°πÁöÑÈÄªËæë
};

// --- Database Selector ---

const selectDatabase = (database) => {
  selectedDatabase.value = database;
  dropdownOpen.value = false;
};

const toggleDropdown = () => {
  dropdownOpen.value = !dropdownOpen.value;
};

const getCurrentDatabaseOption = () => {
  return databaseOptions.value.find(option => option.value === selectedDatabase.value) || databaseOptions.value[2];
};

// --- Deep Thinking Functions ---

const toggleDeepThinking = () => {
  deepThinkingEnabled.value = !deepThinkingEnabled.value;
  console.log('Ê∑±Â∫¶ÊÄùËÄÉÊ®°Âºè:', deepThinkingEnabled.value ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠');
};

// --- Model Selector Functions ---

const selectModel = (model) => {
  selectedModel.value = model;
  modelDropdownOpen.value = false;
  console.log('ÂàáÊç¢Ê®°Âûã:', model);
};

const toggleModelDropdown = () => {
  modelDropdownOpen.value = !modelDropdownOpen.value;
};

const getCurrentModelOption = () => {
  return modelOptions.value.find(option => option.value === selectedModel.value) || modelOptions.value[0];
};

const askRelatedQuestion = (question) => {
  newMessage.value = question;
  nextTick(() => {
    adjustTextareaHeight();
    sendMessage();
  });
};

const highlightQuery = (text) => {
  if (!newMessage.value.trim()) return text;
  const query = newMessage.value.trim();
  const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
  return text.replace(regex, '<strong>$1</strong>');
};

// --- Textarea and Suggestions ---

const handleKeydown = (event) => {
  if (suggestions.value.length > 0) {
    if (event.key === 'ArrowDown') {
      event.preventDefault();
      selectedIndex.value = (selectedIndex.value + 1) % suggestions.value.length;
    } else if (event.key === 'ArrowUp') {
      event.preventDefault();
      if (selectedIndex.value <= 0) {
        selectedIndex.value = suggestions.value.length - 1;
      } else {
        selectedIndex.value--;
      }
    } else if (event.key === 'Enter') {
      if (selectedIndex.value !== -1) {
        event.preventDefault();
        selectSuggestion(suggestions.value[selectedIndex.value]);
      } else if (!event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    } else if (event.key === 'Escape') {
      event.preventDefault();
      clearSuggestions();
    }
  } else if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendMessage();
  }
};

const adjustTextareaHeight = () => {
  const textarea = messageTextarea.value;
  if (textarea) {
    textarea.style.height = 'auto';
    const scrollHeight = textarea.scrollHeight;
    const lineHeight = 24;
    const maxHeight = lineHeight * 10;
    const minHeight = lineHeight * 2;
    const newHeight = Math.min(Math.max(scrollHeight, minHeight), maxHeight);
    textarea.style.height = newHeight + 'px';
  }
};

const handleInput = () => {
  adjustTextareaHeight();
  if (debounceTimer.value) {
    clearTimeout(debounceTimer.value);
  }
  debounceTimer.value = setTimeout(() => {
    fetchSuggestions();
  }, 250);
};

const fetchSuggestions = () => {
  const query = newMessage.value.trim();
  if (!query) {
    suggestions.value = [];
    return;
  }

  const scriptId = 'baidu-jsonp-script';
  const existingScript = document.getElementById(scriptId);
  if (existingScript) {
    existingScript.remove();
  }

  const script = document.createElement('script');
  script.id = scriptId;
  script.src = `https://suggestion.baidu.com/su?wd=${encodeURIComponent(query)}&cb=window.handleBaiduSuggestions`;
  
  script.onerror = () => {
    console.error('Failed to load suggestions.');
    suggestions.value = [];
    if (script.parentNode) {
      script.parentNode.removeChild(script);
    }
  };
  
  script.onload = () => {
      if (script.parentNode) {
          script.parentNode.removeChild(script);
      }
  };

  document.head.appendChild(script);
};

const selectSuggestion = (suggestion) => {
  newMessage.value = suggestion;
  suggestions.value = [];
  selectedIndex.value = -1;
  nextTick(() => {
    adjustTextareaHeight();
    messageTextarea.value.focus();
  });
};

const clearSuggestions = () => {
  setTimeout(() => {
    suggestions.value = [];
    selectedIndex.value = -1;
  }, 150);
};

// --- Lifecycle Hooks ---

const handleClickOutside = (event) => {
  const dbSelector = document.querySelector('.database-selector');
  const modelSelector = document.querySelector('.model-selector');
  
  if (dbSelector && !dbSelector.contains(event.target)) {
    dropdownOpen.value = false;
  }
  
  if (modelSelector && !modelSelector.contains(event.target)) {
    modelDropdownOpen.value = false;
  }
};

onMounted(() => {
  // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
  const userData = localStorage.getItem('ai-chat-user');
  if (userData) {
    currentUser.value = JSON.parse(userData);
  }
  
  document.addEventListener('click', handleClickOutside);
  window.handleBaiduSuggestions = (data) => {
    suggestions.value = data.s || [];
    selectedIndex.value = -1;
  };
  
  // Ê∑ªÂä†ÊªöÂä®‰∫ã‰ª∂ÁõëÂê¨
  nextTick(() => {
    if (messagesContainer.value) {
      messagesContainer.value.addEventListener('scroll', handleScroll);
    }
  });
  
  loadFromStorage(); // ‰ªélocalStorageÂä†ËΩΩÊï∞ÊçÆ
  nextTick(() => {
    scrollToBottom();
    isAtBottom.value = true;
  });
});

onUnmounted(() => {
  document.removeEventListener('click', handleClickOutside);
  if (messagesContainer.value) {
    messagesContainer.value.removeEventListener('scroll', handleScroll);
  }
  delete window.handleBaiduSuggestions;
});
</script>

<style scoped>
/* ÂØºÂÖ•ÂéüÊúâÁöÑÊ†∑Âºè */
@import '../assets/main.css';

/* Êñ∞Â¢ûÁöÑËÅäÂ§©Â§¥ÈÉ®Ê†∑Âºè */
.chat-header {
  padding: 16px 24px;
  border-bottom: 1px solid #e5e7eb;
  background: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 8px;
}

.user-avatar {
  font-size: 20px;
}

.user-name {
  font-weight: 500;
  color: #374151;
}

/* ÈÄÄÂá∫ÁôªÂΩïÊåâÈíÆÊ†∑Âºè */
.logout-btn {
  background: none;
  border: none;
  padding: 8px;
  border-radius: 6px;
  cursor: pointer;
  color: #6b7280;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.logout-btn:hover {
  background: #f3f4f6;
  color: #ef4444;
}

/* Ë∞ÉÊï¥‰æßËæπÊ†èÂ§¥ÈÉ®Â∏ÉÂ±Ä */
.sidebar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px;
  border-bottom: 1px solid #e5e7eb;
}

.sidebar-title {
  margin: 0;
  flex: 1;
  text-align: center;
}

/* ÊåâÈíÆÂ±ÇÊ†∑Âºè */
.button-layer {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

/* Êï∞ÊçÆÂ∫ìÈÄâÊã©Âô®Ê†∑ÂºèÁªü‰∏Ä */
.database-selector .db-selector-btn {
  height: 36px;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.database-selector .db-text {
  font-size: 14px;
}

.database-selector .dropdown-arrow {
  font-size: 12px;
}

/* Ê∑±Â∫¶ÊÄùËÄÉÊåâÈíÆÊ†∑Âºè */
.deep-thinking-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  font-size: 14px;
  color: #6c757d;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
  height: 36px;
}

.deep-thinking-btn:hover {
  background: #e9ecef;
  border-color: #dee2e6;
}

.deep-thinking-btn.active {
  background: #e3f2fd;
  border-color: #2196f3;
  color: #1976d2;
}

.deep-thinking-btn.active svg {
  color: #1976d2;
}

/* Ê®°ÂûãÈÄâÊã©Âô®Ê†∑Âºè */
.model-selector {
  position: relative;
  display: inline-block;
}

.model-selector-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  font-size: 14px;
  color: #495057;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
  min-width: 100px;
  height: 36px;
}

.model-selector-btn:hover {
  background: #e9ecef;
  border-color: #dee2e6;
}

.model-selector.open .model-selector-btn {
  background: #e9ecef;
  border-color: #dee2e6;
}



.model-text {
  flex: 1;
  text-align: left;
  font-size: 14px;
}

.model-label {
  flex: 1;
  text-align: left;
  font-size: 14px;
}

/* Áªü‰∏Ä‰∏ãÊãâËèúÂçïÊ†∑Âºè */
.dropdown-menu {
  font-size: 14px;
}

.dropdown-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
}

.db-label {
  font-size: 14px;
}

.dropdown-arrow {
  font-size: 12px;
  transition: transform 0.2s ease;
}

.database-selector.open .dropdown-arrow,
.model-selector.open .dropdown-arrow {
  transform: rotate(180deg);
}

/* ÊªöÂä®Âà∞Â∫ïÈÉ®ÊåâÈíÆÊ†∑Âºè */
.scroll-to-bottom-btn {
  position: fixed;
  bottom: 188px; /* ÊåâÈíÆÂ∫ïÈÉ®‰∏éÂØπËØùÊ°ÜÂ∫ïÈÉ®ÂØπÈΩê */
  right: 20px;
  width: 48px;
  height: 48px;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
  z-index: 1000;
  color: #6b7280;
}

.scroll-to-bottom-btn:hover {
  background: #f9fafb;
  border-color: #d1d5db;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
  color: #374151;
  transform: translateY(-2px);
}

.scroll-to-bottom-btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.scroll-to-bottom-btn svg {
  transition: transform 0.2s ease;
}

.scroll-to-bottom-btn:hover svg {
  transform: translateY(1px);
}

/* Á°Æ‰øùÊ∂àÊÅØÂÆπÂô®ÊòØÁõ∏ÂØπÂÆö‰ΩçÔºå‰ª•‰æøÊåâÈíÆÊ≠£Á°ÆÂÆö‰Ωç */
.messages-container {
  position: relative;
}

/* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
@media (max-width: 768px) {
  .scroll-to-bottom-btn {
    width: 44px;
    height: 44px;
    bottom: 160px;
    right: 16px;
  }
}

@media (max-width: 768px) {
  .button-layer {
    gap: 6px;
  }
  
  .deep-thinking-btn .btn-text {
    display: none;
  }
  
  .deep-thinking-btn {
    padding: 8px;
    min-width: auto;
  }
  
  .model-selector-btn {
    min-width: 80px;
    padding: 8px 10px;
  }
  
  .model-text {
    font-size: 12px;
  }
}

@media (max-width: 480px) {
  .button-layer {
    flex-direction: column;
    align-items: stretch;
    gap: 8px;
  }
  
  .database-selector,
  .model-selector {
    width: 100%;
  }
  
  .db-selector-btn,
  .model-selector-btn {
    width: 100%;
    justify-content: space-between;
  }
  
  .deep-thinking-btn {
    width: 100%;
    justify-content: center;
  }
  
  .deep-thinking-btn .btn-text {
    display: inline;
  }
}
</style>
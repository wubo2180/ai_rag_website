import{_ as _e,c as d,o as l,q as C,b as n,s as F,d as a,e as u,w as i,h as S,F as G,v as H,y as b,B as R,A as ae,i as ee,u as ge,r as f,n as ve,p as me,G as pe,t as he,x as fe,H as le,E as y,j as ye,I as q,D as ke}from"./index-Imyafj_c.js";import{k as we}from"./marked.esm-z4go5P_g.js";import{u as be}from"./chat-DxZ9y90f.js";const Ce={name:"EnhancedChat",setup(){const I=ye(),t=ge(),M=be(),e=f(!1),T=f(""),m=f([]),c=f(!1),h=f(null),v=f("deepseek"),z=f(!0),K=f([]),x=f(null),A=f(null),E=f([{value:"deepseek",label:"DeepSeek深度思考"},{value:"doubao",label:"豆包"},{value:"gpt5",label:"GPT-5"},{value:"通义千问",label:"通义千问"},{value:"Claude4",label:"Claude 4"}]),O=ve(()=>{var o;return((o=E.value.find(r=>r.value===v.value))==null?void 0:o.label)||v.value}),j=()=>{e.value=!e.value},J=async()=>{if(t.isLoggedIn)try{const o=await q.post("/api/chat/sessions/",{title:"新对话"});h.value=o.data.id,m.value=[],await M.loadSessions()}catch{y.error("创建新会话失败")}else h.value=null,m.value=[]},W=async o=>{try{h.value=o;const r=await q.get(`/api/chat/sessions/${o}/history/`);m.value=r.data.messages||[],e.value=!1,V()}catch{y.error("加载会话失败")}},N=async o=>{try{await le.confirm("确定删除这个对话吗？","确认删除",{type:"warning"}),await q.delete(`/api/chat/sessions/${o}/`),await M.loadSessions(),h.value===o&&(h.value=null,m.value=[]),y.success("删除成功")}catch(r){r!=="cancel"&&y.error("删除失败")}},B=async()=>{if(!T.value.trim()||c.value)return;const o=T.value.trim();T.value="";const r={content:o,is_user:!0,timestamp:new Date};m.value.push(r);const g={content:"",is_user:!1,timestamp:new Date,thinking:"",suggestions:[]};m.value.push(g),V(),c.value=!0;try{await U(o,v.value,z.value,g)}catch(_){console.error("发送消息失败:",_),g.content="抱歉，发送消息时出现错误，请稍后重试。",y.error("发送消息失败")}finally{c.value=!1}},U=async(o,r,g,_)=>{const ie={message:o,model:r,session_id:h.value,deep_thinking:g},te=new AbortController,$=((p,L)=>L&&p==="deepseek"?3e5:p==="GPT-5"?18e4:["豆包","Claude4"].includes(p)?12e4:9e4)(r,g),se=setTimeout(()=>{te.abort(),console.log(`请求超时: ${r} (${$/1e3}秒)`)},$);try{const p=await fetch("/api/chat/api/stream/",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.token}`},body:JSON.stringify(ie),signal:te.signal});if(clearTimeout(se),!p.ok)throw new Error(`HTTP error! status: ${p.status}`);const L=p.body.getReader(),re=new TextDecoder;for(;;){const{done:ce,value:de}=await L.read();if(ce)break;const ue=re.decode(de).split(`
`);for(const oe of ue)if(oe.startsWith("data: ")){const ne=oe.slice(6);if(ne==="[DONE]"){try{const k=await q.post("/api/chat/suggestions/",{query:o});_.suggestions=k.data.suggestions||[]}catch(k){console.error("获取推荐问题失败:",k)}return}try{const k=JSON.parse(ne);k.content&&(_.content+=k.content),k.thinking&&(_.thinking+=k.thinking),V()}catch(k){console.error("解析流数据失败:",k)}}}}catch(p){if(clearTimeout(se),console.error("流式请求失败:",p),p.name==="AbortError"){const L=`请求超时 (${$/1e3}秒)。${g?"deepseek深度思考":r}模型响应较慢，请稍后重试。`;_.content=L,y.error(L)}else _.content="发送消息失败，请重试",y.error("发送消息失败: "+p.message);throw p}},Q=()=>{A.value&&(A.value.close(),A.value=null),c.value=!1},X=o=>{T.value=o,B()},Y=async o=>{if(o<=0||c.value)return;const r=m.value[o-1];if(!r||r.is_user!==!0)return;const g=m.value[o];g.content="",g.thinking="",g.suggestions=[],c.value=!0;try{await U(r.content,v.value,z.value,g)}catch(_){console.error("重新生成失败:",_),g.content="重新生成失败，请稍后重试。",y.error("重新生成失败")}finally{c.value=!1}},Z=async o=>{try{await navigator.clipboard.writeText(o),y.success("已复制到剪贴板")}catch{y.error("复制失败")}},s=o=>we(o||""),D=o=>{const r=new Date(o),_=new Date-r;return _<6e4?"刚刚":_<36e5?`${Math.floor(_/6e4)}分钟前`:_<864e5?`${Math.floor(_/36e5)}小时前`:r.toLocaleDateString()},V=()=>{ke(()=>{x.value&&(x.value.scrollTop=x.value.scrollHeight)})},P=o=>{switch(o){case"profile":I.push("/profile");break;case"logout":w();break}},w=async()=>{try{await le.confirm("确定要退出登录吗？","确认退出",{type:"warning"}),t.logout(),h.value=null,m.value=[],y.success("已退出登录"),I.push("/login")}catch{}};return me(async()=>{t.isLoggedIn&&(await M.loadSessions(),await M.loadAvailableModels())}),pe(()=>t.isLoggedIn,async o=>{o?await M.loadSessions():(h.value=null,m.value=[])}),{sidebarOpen:e,inputMessage:T,messages:m,isTyping:c,currentSessionId:h,selectedModel:v,deepThinking:z,activeThinking:K,messagesContainer:x,availableModels:E,selectedModelLabel:O,userStore:t,chatStore:M,toggleSidebar:j,startNewChat:J,loadSession:W,deleteSession:N,sendMessage:B,stopGeneration:Q,askSuggestion:X,regenerateResponse:Y,copyMessage:Z,renderMarkdown:s,formatTime:D,handleUserAction:P,logout:w,Menu:fe,Close:he}}},Se={class:"enhanced-chat-container"},Me={class:"sidebar-header"},Te={class:"history"},xe={class:"session-list"},De=["onClick"],Ve={class:"session-content"},Le={class:"session-title"},Re={key:0,class:"sidebar-toggle-floating"},ze={class:"chat-header"},Ae={class:"header-left"},Ie={key:0},Ee={key:1},Oe={class:"header-right"},Ne={key:0,class:"user-actions"},Be={class:"messages-container",ref:"messagesContainer"},Ue={class:"message-avatar"},Pe={key:1,class:"ai-avatar"},Fe={class:"message-content"},Ge={class:"message-header"},He={class:"sender-name"},qe={class:"message-time"},Ke={key:0,class:"message-text user-text"},je={key:1,class:"message-text ai-text"},Je={key:0,class:"thinking-process"},We={class:"thinking-content"},Qe=["innerHTML"],Xe={key:1,class:"suggestions"},Ye={class:"message-actions"},Ze={key:0,class:"typing-indicator"},$e={class:"message-wrapper ai-message"},et={class:"message-avatar"},tt={class:"ai-avatar"},st={class:"input-area"},ot={class:"input-wrapper"},nt={class:"input-actions"};function at(I,t,M,e,T,m){const c=u("el-button"),h=u("ChatDotRound"),v=u("el-icon"),z=u("Delete"),K=u("el-option"),x=u("el-select"),A=u("el-switch"),E=u("ArrowDown"),O=u("el-dropdown-item"),j=u("el-dropdown-menu"),J=u("el-dropdown"),W=u("el-avatar"),N=u("Robot"),B=u("el-collapse-item"),U=u("el-collapse"),Q=u("el-tag"),X=u("CopyDocument"),Y=u("RefreshRight"),Z=u("el-input");return l(),d("div",Se,[e.userStore.isLoggedIn?(l(),d("div",{key:0,class:F(["sidebar",{open:e.sidebarOpen}])},[n("div",Me,[t[6]||(t[6]=n("h2",{class:"sidebar-title"},"AI 材料智能助手",-1)),a(c,{class:"sidebar-close-icon",link:"",circle:"",icon:e.Close,onClick:e.toggleSidebar,title:"隐藏会话列表"},null,8,["icon","onClick"])]),a(c,{type:"primary",onClick:e.startNewChat,class:"new-chat-btn",icon:"Plus"},{default:i(()=>[...t[7]||(t[7]=[S(" 开启新对话 ",-1)])]),_:1},8,["onClick"]),n("div",Te,[t[8]||(t[8]=n("h3",null,"对话历史",-1)),n("div",xe,[(l(!0),d(G,null,H(e.chatStore.sessions,s=>(l(),d("div",{key:s.id,class:F(["session-item",{active:e.currentSessionId===s.id}]),onClick:D=>e.loadSession(s.id)},[n("div",Ve,[a(v,null,{default:i(()=>[a(h)]),_:1}),n("span",Le,b(s.title||"新对话"),1)]),a(c,{type:"text",size:"small",onClick:ee(D=>e.deleteSession(s.id),["stop"]),class:"delete-btn",title:"删除对话"},{default:i(()=>[a(v,null,{default:i(()=>[a(z)]),_:1})]),_:1},8,["onClick"])],10,De))),128))])])],2)):C("",!0),e.userStore.isLoggedIn&&e.sidebarOpen?(l(),d("div",{key:1,class:"sidebar-backdrop",onClick:t[0]||(t[0]=(...s)=>e.toggleSidebar&&e.toggleSidebar(...s))})):C("",!0),n("div",{class:F(["main-chat",{"sidebar-open":e.sidebarOpen}])},[e.userStore.isLoggedIn?(l(),d("div",Re,[a(c,{circle:"",size:"large",icon:e.sidebarOpen?e.Close:e.Menu,onClick:e.toggleSidebar,title:e.sidebarOpen?"隐藏会话列表":"显示会话列表"},null,8,["icon","onClick","title"])])):C("",!0),n("div",ze,[n("div",Ae,[e.chatStore.currentSession?(l(),d("h3",Ie,b(e.chatStore.currentSession.title||"新对话"),1)):(l(),d("h3",Ee,"AI 材料智能助手"))]),n("div",Oe,[a(x,{modelValue:e.selectedModel,"onUpdate:modelValue":t[1]||(t[1]=s=>e.selectedModel=s),placeholder:"选择AI模型",size:"small",style:{width:"180px","margin-right":"10px"}},{default:i(()=>[(l(!0),d(G,null,H(e.availableModels,s=>(l(),R(K,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(A,{modelValue:e.deepThinking,"onUpdate:modelValue":t[2]||(t[2]=s=>e.deepThinking=s),"active-text":"深度思考","inactive-text":"普通模式",size:"small",style:{"margin-right":"15px"}},null,8,["modelValue"]),e.userStore.isLoggedIn?(l(),d("div",Ne,[a(J,{onCommand:e.handleUserAction},{dropdown:i(()=>[a(j,null,{default:i(()=>[a(O,{command:"profile"},{default:i(()=>[...t[9]||(t[9]=[S("个人资料",-1)])]),_:1}),a(O,{command:"logout",divided:""},{default:i(()=>[...t[10]||(t[10]=[S("退出登录",-1)])]),_:1})]),_:1})]),default:i(()=>[a(c,{type:"text"},{default:i(()=>{var s;return[S(b(((s=e.userStore.user)==null?void 0:s.username)||"用户")+" ",1),a(v,null,{default:i(()=>[a(E)]),_:1})]}),_:1})]),_:1},8,["onCommand"])])):(l(),R(c,{key:1,type:"primary",size:"small",onClick:t[3]||(t[3]=s=>I.$router.push("/login"))},{default:i(()=>[...t[11]||(t[11]=[S(" 登录 ",-1)])]),_:1}))])]),n("div",Be,[(l(!0),d(G,null,H(e.messages,(s,D)=>{var V,P;return l(),d("div",{key:D,class:F(["message-wrapper",{"user-message":s.is_user,"ai-message":!s.is_user}])},[n("div",Ue,[s.is_user?(l(),R(W,{key:0,size:32,src:(V=e.userStore.user)==null?void 0:V.avatar,icon:"UserFilled"},null,8,["src"])):(l(),d("div",Pe,[a(v,null,{default:i(()=>[a(N)]),_:1})]))]),n("div",Fe,[n("div",Ge,[n("span",He,b(s.is_user?((P=e.userStore.user)==null?void 0:P.username)||"我":e.selectedModelLabel),1),n("span",qe,b(e.formatTime(s.timestamp)),1)]),s.is_user?(l(),d("div",Ke,b(s.content),1)):(l(),d("div",je,[s.thinking?(l(),d("div",Je,[a(U,{modelValue:e.activeThinking,"onUpdate:modelValue":t[4]||(t[4]=w=>e.activeThinking=w)},{default:i(()=>[a(B,{title:"🧠 深度思考过程",name:"thinking"},{default:i(()=>[n("div",We,b(s.thinking),1)]),_:2},1024)]),_:2},1032,["modelValue"])])):C("",!0),n("div",{innerHTML:e.renderMarkdown(s.content),class:"markdown-content"},null,8,Qe),s.suggestions&&s.suggestions.length?(l(),d("div",Xe,[t[12]||(t[12]=n("h4",null,"💡 相关问题",-1)),(l(!0),d(G,null,H(s.suggestions,(w,o)=>(l(),R(Q,{key:o,onClick:r=>e.askSuggestion(w),class:"suggestion-tag",type:"info",effect:"plain"},{default:i(()=>[S(b(w),1)]),_:2},1032,["onClick"]))),128))])):C("",!0)]))]),n("div",Ye,[a(c,{type:"text",size:"small",onClick:w=>e.copyMessage(s.content),title:"复制"},{default:i(()=>[a(v,null,{default:i(()=>[a(X)]),_:1})]),_:1},8,["onClick"]),s.is_user?C("",!0):(l(),R(c,{key:0,type:"text",size:"small",onClick:w=>e.regenerateResponse(D),title:"重新生成"},{default:i(()=>[a(v,null,{default:i(()=>[a(Y)]),_:1})]),_:1},8,["onClick"]))])],2)}),128)),e.isTyping?(l(),d("div",Ze,[n("div",$e,[n("div",et,[n("div",tt,[a(v,null,{default:i(()=>[a(N)]),_:1})])]),t[13]||(t[13]=n("div",{class:"message-content"},[n("div",{class:"typing-animation"},[n("span"),n("span"),n("span")])],-1))])])):C("",!0)],512),n("div",st,[n("div",ot,[a(Z,{modelValue:e.inputMessage,"onUpdate:modelValue":t[5]||(t[5]=s=>e.inputMessage=s),type:"textarea",rows:3,placeholder:"输入您的问题...",onKeydown:[ae(ee(e.sendMessage,["ctrl"]),["enter"]),ae(ee(e.sendMessage,["meta"]),["enter"])],resize:"none",maxlength:"4000","show-word-limit":""},null,8,["modelValue","onKeydown"]),n("div",nt,[a(c,{type:"primary",onClick:e.sendMessage,loading:e.isTyping,disabled:!e.inputMessage.trim()||e.isTyping,icon:"Position"},{default:i(()=>[S(b(e.isTyping?"发送中...":"发送"),1)]),_:1},8,["onClick","loading","disabled"]),e.isTyping?(l(),R(c,{key:0,onClick:e.stopGeneration,type:"danger",plain:"",size:"small"},{default:i(()=>[...t[14]||(t[14]=[S(" 停止生成 ",-1)])]),_:1},8,["onClick"])):C("",!0)])]),t[15]||(t[15]=n("div",{class:"input-tips"},[n("span",{class:"shortcut-tip"},"Ctrl + Enter 快速发送")],-1))])],2)])}const ut=_e(Ce,[["render",at],["__scopeId","data-v-253b390c"]]);export{ut as default};

import{_ as _e,c as u,o as i,b as n,z as b,q as w,d as a,w as r,e as c,h as S,F as U,s as P,y as $,t as C,x as ae,i as ee,u as ge,r as h,n as pe,p as me,C as ve,D as le,E as f,j as he,G as F,B as fe}from"./index-Dw5cNvgt.js";import{k as ye}from"./marked.esm-z4go5P_g.js";import{u as ke}from"./chat-BdPHgVGp.js";const we={name:"EnhancedChat",setup(){const B=he(),s=ge(),M=ke(),e=h(!1),x=h(""),m=h([]),y=h(!1),d=h(null),T=h("deepseek"),p=h(!0),G=h([]),D=h(null),z=h(null),E=h([{value:"deepseek",label:"DeepSeek深度思考"},{value:"doubao",label:"豆包"},{value:"gpt5",label:"GPT-5"},{value:"通义千问",label:"通义千问"},{value:"Claude4",label:"Claude 4"}]),H=pe(()=>{var o;return((o=E.value.find(l=>l.value===T.value))==null?void 0:o.label)||T.value}),O=()=>{e.value=!e.value},N=async()=>{if(s.isLoggedIn)try{const o=await F.post("/api/chat/sessions/",{title:"新对话"});d.value=o.data.id,m.value=[],await M.loadSessions()}catch{f.error("创建新会话失败")}else d.value=null,m.value=[]},q=async o=>{try{d.value=o;const l=await F.get(`/api/chat/sessions/${o}/history/`);m.value=l.data.messages||[],t()}catch{f.error("加载会话失败")}},K=async o=>{try{await le.confirm("确定删除这个对话吗？","确认删除",{type:"warning"}),await F.delete(`/api/chat/sessions/${o}/`),await M.loadSessions(),d.value===o&&(d.value=null,m.value=[]),f.success("删除成功")}catch(l){l!=="cancel"&&f.error("删除失败")}},I=async()=>{if(!x.value.trim()||y.value)return;const o=x.value.trim();x.value="";const l={content:o,is_user:!0,timestamp:new Date};m.value.push(l);const _={content:"",is_user:!1,timestamp:new Date,thinking:"",suggestions:[]};m.value.push(_),t(),y.value=!0;try{await L(o,T.value,p.value,_)}catch(g){console.error("发送消息失败:",g),_.content="抱歉，发送消息时出现错误，请稍后重试。",f.error("发送消息失败")}finally{y.value=!1}},L=async(o,l,_,g)=>{const ie={message:o,model:l,session_id:d.value,deep_thinking:_},te=new AbortController,Z=((v,R)=>R&&v==="deepseek"?3e5:v==="GPT-5"?18e4:["豆包","Claude4"].includes(v)?12e4:9e4)(l,_),se=setTimeout(()=>{te.abort(),console.log(`请求超时: ${l} (${Z/1e3}秒)`)},Z);try{const v=await fetch("/api/chat/api/stream/",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.token}`},body:JSON.stringify(ie),signal:te.signal});if(clearTimeout(se),!v.ok)throw new Error(`HTTP error! status: ${v.status}`);const R=v.body.getReader(),re=new TextDecoder;for(;;){const{done:ce,value:de}=await R.read();if(ce)break;const ue=re.decode(de).split(`
`);for(const oe of ue)if(oe.startsWith("data: ")){const ne=oe.slice(6);if(ne==="[DONE]"){try{const k=await F.post("/api/chat/suggestions/",{query:o});g.suggestions=k.data.suggestions||[]}catch(k){console.error("获取推荐问题失败:",k)}return}try{const k=JSON.parse(ne);k.content&&(g.content+=k.content),k.thinking&&(g.thinking+=k.thinking),t()}catch(k){console.error("解析流数据失败:",k)}}}}catch(v){if(clearTimeout(se),console.error("流式请求失败:",v),v.name==="AbortError"){const R=`请求超时 (${Z/1e3}秒)。${_?"deepseek深度思考":l}模型响应较慢，请稍后重试。`;g.content=R,f.error(R)}else g.content="发送消息失败，请重试",f.error("发送消息失败: "+v.message);throw v}},j=()=>{z.value&&(z.value.close(),z.value=null),y.value=!1},J=o=>{x.value=o,I()},W=async o=>{if(o<=0||y.value)return;const l=m.value[o-1];if(!l||l.is_user!==!0)return;const _=m.value[o];_.content="",_.thinking="",_.suggestions=[],y.value=!0;try{await L(l.content,T.value,p.value,_)}catch(g){console.error("重新生成失败:",g),_.content="重新生成失败，请稍后重试。",f.error("重新生成失败")}finally{y.value=!1}},Q=async o=>{try{await navigator.clipboard.writeText(o),f.success("已复制到剪贴板")}catch{f.error("复制失败")}},X=o=>ye(o||""),Y=o=>{const l=new Date(o),g=new Date-l;return g<6e4?"刚刚":g<36e5?`${Math.floor(g/6e4)}分钟前`:g<864e5?`${Math.floor(g/36e5)}小时前`:l.toLocaleDateString()},t=()=>{fe(()=>{D.value&&(D.value.scrollTop=D.value.scrollHeight)})},V=o=>{switch(o){case"profile":B.push("/profile");break;case"logout":A();break}},A=async()=>{try{await le.confirm("确定要退出登录吗？","确认退出",{type:"warning"}),s.logout(),d.value=null,m.value=[],f.success("已退出登录"),B.push("/login")}catch{}};return me(async()=>{s.isLoggedIn&&(await M.loadSessions(),await M.loadAvailableModels())}),ve(()=>s.isLoggedIn,async o=>{o?await M.loadSessions():(d.value=null,m.value=[])}),{sidebarCollapsed:e,inputMessage:x,messages:m,isTyping:y,currentSessionId:d,selectedModel:T,deepThinking:p,activeThinking:G,messagesContainer:D,availableModels:E,selectedModelLabel:H,userStore:s,chatStore:M,toggleSidebar:O,startNewChat:N,loadSession:q,deleteSession:K,sendMessage:I,stopGeneration:j,askSuggestion:J,regenerateResponse:W,copyMessage:Q,renderMarkdown:X,formatTime:Y,handleUserAction:V,logout:A}}},Ce={class:"enhanced-chat-container"},be={class:"sidebar-header"},Se={key:0,class:"sidebar-title"},Me={key:1,class:"history"},Te={class:"session-list"},xe=["onClick"],De={class:"session-content"},Ve={class:"session-title"},Re={key:2,class:"collapsed-actions"},ze={class:"main-chat"},Le={class:"chat-header"},Ae={class:"header-left"},Be={key:0},Ee={key:1},Ne={class:"header-right"},Ie={key:0,class:"user-actions"},Ue={class:"messages-container",ref:"messagesContainer"},Pe={class:"message-avatar"},Fe={key:1,class:"ai-avatar"},Ge={class:"message-content"},He={class:"message-header"},Oe={class:"sender-name"},qe={class:"message-time"},Ke={key:0,class:"message-text user-text"},je={key:1,class:"message-text ai-text"},Je={key:0,class:"thinking-process"},We={class:"thinking-content"},Qe=["innerHTML"],Xe={key:1,class:"suggestions"},Ye={class:"message-actions"},Ze={key:0,class:"typing-indicator"},$e={class:"message-wrapper ai-message"},et={class:"message-avatar"},tt={class:"ai-avatar"},st={class:"input-area"},ot={class:"input-wrapper"},nt={class:"input-actions"};function at(B,s,M,e,x,m){const y=c("Menu"),d=c("el-icon"),T=c("SwitchButton"),p=c("el-button"),G=c("ChatDotRound"),D=c("Delete"),z=c("el-option"),E=c("el-select"),H=c("el-switch"),O=c("ArrowDown"),N=c("el-dropdown-item"),q=c("el-dropdown-menu"),K=c("el-dropdown"),I=c("el-avatar"),L=c("Robot"),j=c("el-collapse-item"),J=c("el-collapse"),W=c("el-tag"),Q=c("CopyDocument"),X=c("RefreshRight"),Y=c("el-input");return i(),u("div",Ce,[n("div",{class:$(["sidebar",{collapsed:e.sidebarCollapsed}])},[n("div",be,[n("button",{class:"menu-toggle",onClick:s[0]||(s[0]=(...t)=>e.toggleSidebar&&e.toggleSidebar(...t))},[a(d,null,{default:r(()=>[a(y)]),_:1})]),e.sidebarCollapsed?w("",!0):(i(),u("h2",Se,"AI 智能助手")),!e.sidebarCollapsed&&e.userStore.isLoggedIn?(i(),b(p,{key:1,type:"text",onClick:e.logout,class:"logout-btn",title:"退出登录"},{default:r(()=>[a(d,null,{default:r(()=>[a(T)]),_:1})]),_:1},8,["onClick"])):w("",!0)]),e.sidebarCollapsed?w("",!0):(i(),b(p,{key:0,type:"primary",onClick:e.startNewChat,class:"new-chat-btn",icon:"Plus"},{default:r(()=>[...s[6]||(s[6]=[S(" 开启新对话 ",-1)])]),_:1},8,["onClick"])),!e.sidebarCollapsed&&e.userStore.isLoggedIn?(i(),u("div",Me,[s[7]||(s[7]=n("h3",null,"对话历史",-1)),n("div",Te,[(i(!0),u(U,null,P(e.chatStore.sessions,t=>(i(),u("div",{key:t.id,class:$(["session-item",{active:e.currentSessionId===t.id}]),onClick:V=>e.loadSession(t.id)},[n("div",De,[a(d,null,{default:r(()=>[a(G)]),_:1}),n("span",Ve,C(t.title||"新对话"),1)]),a(p,{type:"text",size:"small",onClick:ee(V=>e.deleteSession(t.id),["stop"]),class:"delete-btn",title:"删除对话"},{default:r(()=>[a(d,null,{default:r(()=>[a(D)]),_:1})]),_:1},8,["onClick"])],10,xe))),128))])])):w("",!0),e.sidebarCollapsed?(i(),u("div",Re,[a(p,{type:"primary",circle:"",onClick:e.startNewChat,title:"新建对话",icon:"Plus"},null,8,["onClick"])])):w("",!0)],2),n("div",ze,[n("div",Le,[n("div",Ae,[e.chatStore.currentSession?(i(),u("h3",Be,C(e.chatStore.currentSession.title||"新对话"),1)):(i(),u("h3",Ee,"AI 智能助手"))]),n("div",Ne,[a(E,{modelValue:e.selectedModel,"onUpdate:modelValue":s[1]||(s[1]=t=>e.selectedModel=t),placeholder:"选择AI模型",size:"small",style:{width:"180px","margin-right":"10px"}},{default:r(()=>[(i(!0),u(U,null,P(e.availableModels,t=>(i(),b(z,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(H,{modelValue:e.deepThinking,"onUpdate:modelValue":s[2]||(s[2]=t=>e.deepThinking=t),"active-text":"深度思考","inactive-text":"普通模式",size:"small",style:{"margin-right":"15px"}},null,8,["modelValue"]),e.userStore.isLoggedIn?(i(),u("div",Ie,[a(K,{onCommand:e.handleUserAction},{dropdown:r(()=>[a(q,null,{default:r(()=>[a(N,{command:"profile"},{default:r(()=>[...s[8]||(s[8]=[S("个人资料",-1)])]),_:1}),a(N,{command:"logout",divided:""},{default:r(()=>[...s[9]||(s[9]=[S("退出登录",-1)])]),_:1})]),_:1})]),default:r(()=>[a(p,{type:"text"},{default:r(()=>{var t;return[S(C(((t=e.userStore.user)==null?void 0:t.username)||"用户")+" ",1),a(d,null,{default:r(()=>[a(O)]),_:1})]}),_:1})]),_:1},8,["onCommand"])])):(i(),b(p,{key:1,type:"primary",size:"small",onClick:s[3]||(s[3]=t=>B.$router.push("/login"))},{default:r(()=>[...s[10]||(s[10]=[S(" 登录 ",-1)])]),_:1}))])]),n("div",Ue,[(i(!0),u(U,null,P(e.messages,(t,V)=>{var A,o;return i(),u("div",{key:V,class:$(["message-wrapper",{"user-message":t.is_user,"ai-message":!t.is_user}])},[n("div",Pe,[t.is_user?(i(),b(I,{key:0,size:32,src:(A=e.userStore.user)==null?void 0:A.avatar,icon:"UserFilled"},null,8,["src"])):(i(),u("div",Fe,[a(d,null,{default:r(()=>[a(L)]),_:1})]))]),n("div",Ge,[n("div",He,[n("span",Oe,C(t.is_user?((o=e.userStore.user)==null?void 0:o.username)||"我":e.selectedModelLabel),1),n("span",qe,C(e.formatTime(t.timestamp)),1)]),t.is_user?(i(),u("div",Ke,C(t.content),1)):(i(),u("div",je,[t.thinking?(i(),u("div",Je,[a(J,{modelValue:e.activeThinking,"onUpdate:modelValue":s[4]||(s[4]=l=>e.activeThinking=l)},{default:r(()=>[a(j,{title:"🧠 深度思考过程",name:"thinking"},{default:r(()=>[n("div",We,C(t.thinking),1)]),_:2},1024)]),_:2},1032,["modelValue"])])):w("",!0),n("div",{innerHTML:e.renderMarkdown(t.content),class:"markdown-content"},null,8,Qe),t.suggestions&&t.suggestions.length?(i(),u("div",Xe,[s[11]||(s[11]=n("h4",null,"💡 相关问题",-1)),(i(!0),u(U,null,P(t.suggestions,(l,_)=>(i(),b(W,{key:_,onClick:g=>e.askSuggestion(l),class:"suggestion-tag",type:"info",effect:"plain"},{default:r(()=>[S(C(l),1)]),_:2},1032,["onClick"]))),128))])):w("",!0)]))]),n("div",Ye,[a(p,{type:"text",size:"small",onClick:l=>e.copyMessage(t.content),title:"复制"},{default:r(()=>[a(d,null,{default:r(()=>[a(Q)]),_:1})]),_:1},8,["onClick"]),t.is_user?w("",!0):(i(),b(p,{key:0,type:"text",size:"small",onClick:l=>e.regenerateResponse(V),title:"重新生成"},{default:r(()=>[a(d,null,{default:r(()=>[a(X)]),_:1})]),_:1},8,["onClick"]))])],2)}),128)),e.isTyping?(i(),u("div",Ze,[n("div",$e,[n("div",et,[n("div",tt,[a(d,null,{default:r(()=>[a(L)]),_:1})])]),s[12]||(s[12]=n("div",{class:"message-content"},[n("div",{class:"typing-animation"},[n("span"),n("span"),n("span")])],-1))])])):w("",!0)],512),n("div",st,[n("div",ot,[a(Y,{modelValue:e.inputMessage,"onUpdate:modelValue":s[5]||(s[5]=t=>e.inputMessage=t),type:"textarea",rows:3,placeholder:"输入您的问题...",onKeydown:[ae(ee(e.sendMessage,["ctrl"]),["enter"]),ae(ee(e.sendMessage,["meta"]),["enter"])],resize:"none",maxlength:"4000","show-word-limit":""},null,8,["modelValue","onKeydown"]),n("div",nt,[a(p,{type:"primary",onClick:e.sendMessage,loading:e.isTyping,disabled:!e.inputMessage.trim()||e.isTyping,icon:"Position"},{default:r(()=>[S(C(e.isTyping?"发送中...":"发送"),1)]),_:1},8,["onClick","loading","disabled"]),e.isTyping?(i(),b(p,{key:0,onClick:e.stopGeneration,type:"danger",plain:"",size:"small"},{default:r(()=>[...s[13]||(s[13]=[S(" 停止生成 ",-1)])]),_:1},8,["onClick"])):w("",!0)])]),s[14]||(s[14]=n("div",{class:"input-tips"},[n("span",{class:"shortcut-tip"},"Ctrl + Enter 快速发送")],-1))])])])}const ut=_e(we,[["render",at],["__scopeId","data-v-a867c749"]]);export{ut as default};

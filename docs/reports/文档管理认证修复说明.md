# æ–‡æ¡£ç®¡ç†è®¤è¯é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ”§ é—®é¢˜æè¿°
æ‰“å¼€æ–‡æ¡£ç®¡ç†é¡µé¢æ—¶å‡ºç°ï¼š`Unauthorized: /api/documents/categories/`

## âœ… è§£å†³æ–¹æ¡ˆ

### é—®é¢˜åŸå› 
å‰ç«¯ä»£ç ä½¿ç”¨äº† `localStorage.getItem('token')` è·å–tokenï¼Œä½†å®é™…tokenå­˜å‚¨åœ¨ `access_token` ä¸­ã€‚

### ä¿®å¤å†…å®¹

#### 1. æ›´æ–° DocumentsNew.vue
- âœ… å¯¼å…¥ `apiClient` å’Œ `useUserStore`
- âœ… å°†æ‰€æœ‰ axios è°ƒç”¨æ”¹ä¸ºä½¿ç”¨ apiClient
- âœ… ç§»é™¤æ‰‹åŠ¨æ·»åŠ  Authorization header
- âœ… æ·»åŠ ç™»å½•çŠ¶æ€æ£€æŸ¥
- âœ… æ·»åŠ 401é”™è¯¯è‡ªåŠ¨è·³è½¬ç™»å½•

#### 2. ä½¿ç”¨ç»Ÿä¸€çš„APIå®¢æˆ·ç«¯
`apiClient` å·²é…ç½®è‡ªåŠ¨æ·»åŠ tokenåˆ°è¯·æ±‚å¤´ï¼š
```javascript
// src/utils/api.js
apiClient.interceptors.request.use((config) => {
  const token = localStorage.getItem('access_token')
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})
```

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. ç¡®ä¿å·²ç™»å½•
è®¿é—®æ–‡æ¡£ç®¡ç†é¡µé¢å‰ï¼Œè¯·å…ˆç™»å½•ç³»ç»Ÿï¼š
- è®¿é—® http://localhost:5173/login
- è¾“å…¥ç”¨æˆ·åå’Œå¯†ç 
- ç™»å½•æˆåŠŸåä¼šè‡ªåŠ¨ä¿å­˜ access_token

### 2. è®¿é—®æ–‡æ¡£ç®¡ç†
ç™»å½•åï¼Œç‚¹å‡»å¯¼èˆªæ çš„ **ğŸ“ æ–‡æ¡£ç®¡ç†** æŒ‰é’®å³å¯æ­£å¸¸ä½¿ç”¨ã€‚

### 3. Tokenè‡ªåŠ¨ç®¡ç†
- âœ… ç™»å½•æ—¶è‡ªåŠ¨ä¿å­˜token
- âœ… æ¯æ¬¡è¯·æ±‚è‡ªåŠ¨æºå¸¦token
- âœ… Tokenè¿‡æœŸè‡ªåŠ¨åˆ·æ–°
- âœ… åˆ·æ–°å¤±è´¥è‡ªåŠ¨è·³è½¬ç™»å½•é¡µ

---

## ğŸ” éªŒè¯ä¿®å¤

### æµ‹è¯•æ­¥éª¤
1. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’ŒlocalStorage**
   - æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
   - Application â†’ Storage â†’ Clear site data

2. **é‡æ–°ç™»å½•**
   - è®¿é—® http://localhost:5173/login
   - è¾“å…¥ç”¨æˆ·åå¯†ç ç™»å½•

3. **è®¿é—®æ–‡æ¡£ç®¡ç†**
   - ç‚¹å‡» ğŸ“ æ–‡æ¡£ç®¡ç†
   - åº”è¯¥èƒ½æ­£å¸¸çœ‹åˆ°åˆ†ç±»åˆ—è¡¨

4. **æ£€æŸ¥ç½‘ç»œè¯·æ±‚**
   - æ‰“å¼€ Network æ ‡ç­¾
   - æŸ¥çœ‹ `/api/documents/categories/` è¯·æ±‚
   - Headers ä¸­åº”è¯¥æœ‰ `Authorization: Bearer <token>`

---

## ğŸ“‹ ä¿®æ”¹çš„æ–‡ä»¶

```
frontend/src/views/DocumentsNew.vue
- å¯¼å…¥ apiClient å’Œ useUserStore
- æ›´æ–°æ‰€æœ‰APIè°ƒç”¨æ–¹æ³•
- æ·»åŠ ç™»å½•çŠ¶æ€æ£€æŸ¥
- æ”¹è¿›é”™è¯¯å¤„ç†
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ç»Ÿä¸€ä½¿ç”¨ apiClient
```javascript
// âŒ ä¸æ¨è
import axios from 'axios'
const token = localStorage.getItem('token')
axios.get('/api/xxx', {
  headers: { Authorization: `Bearer ${token}` }
})

// âœ… æ¨è
import apiClient from '@/utils/api'
apiClient.get('/api/xxx')  // tokenè‡ªåŠ¨æ·»åŠ 
```

### 2. æ£€æŸ¥ç™»å½•çŠ¶æ€
```javascript
import { useUserStore } from '@/stores/user'
const userStore = useUserStore()

if (!userStore.isLoggedIn) {
  ElMessage.warning('è¯·å…ˆç™»å½•')
  router.push('/login')
  return
}
```

### 3. é”™è¯¯å¤„ç†
```javascript
try {
  const response = await apiClient.get('/api/xxx')
  // å¤„ç†æˆåŠŸ
} catch (error) {
  ElMessage.error('æ“ä½œå¤±è´¥: ' + (error.response?.data?.detail || error.message))
  if (error.response?.status === 401) {
    router.push('/login')
  }
}
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: è¿˜æ˜¯æ˜¾ç¤º Unauthorizedï¼Ÿ
**A**: 
1. ç¡®è®¤å·²ç™»å½•ï¼ˆæ£€æŸ¥ localStorage ä¸­æ˜¯å¦æœ‰ access_tokenï¼‰
2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
3. é‡æ–°ç™»å½•
4. æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ

### Q2: ç™»å½•åç«‹å³æ˜¾ç¤ºæœªæˆæƒï¼Ÿ
**A**: 
1. æ£€æŸ¥ token æ˜¯å¦æ­£ç¡®ä¿å­˜ï¼š
   ```javascript
   console.log(localStorage.getItem('access_token'))
   ```
2. æ£€æŸ¥ apiClient æ‹¦æˆªå™¨æ˜¯å¦ç”Ÿæ•ˆ
3. æŸ¥çœ‹ Network è¯·æ±‚å¤´æ˜¯å¦åŒ…å« Authorization

### Q3: éƒ¨åˆ†è¯·æ±‚æ­£å¸¸ï¼Œéƒ¨åˆ†401ï¼Ÿ
**A**: 
1. å¯èƒ½æ˜¯ token è¿‡æœŸ
2. æ£€æŸ¥ refresh_token æ˜¯å¦æœ‰æ•ˆ
3. åç«¯ token åˆ·æ–°æ¥å£æ˜¯å¦æ­£å¸¸

---

## ğŸ” Tokenç®¡ç†æœºåˆ¶

### Tokenå­˜å‚¨
```javascript
// ç™»å½•æ—¶ä¿å­˜
localStorage.setItem('access_token', token)
localStorage.setItem('refresh_token', refreshToken)

// è¯·æ±‚æ—¶è‡ªåŠ¨è¯»å–
const token = localStorage.getItem('access_token')
```

### Tokenåˆ·æ–°
å½“æ”¶åˆ°401å“åº”æ—¶ï¼Œè‡ªåŠ¨å°è¯•åˆ·æ–°tokenï¼š
```javascript
if (error.response?.status === 401) {
  const refreshToken = localStorage.getItem('refresh_token')
  const response = await axios.post('/api/auth/token/refresh/', {
    refresh: refreshToken
  })
  // ä¿å­˜æ–°tokenå¹¶é‡è¯•è¯·æ±‚
}
```

### Tokenæ¸…é™¤
```javascript
// é€€å‡ºç™»å½•æ—¶æ¸…é™¤
localStorage.removeItem('access_token')
localStorage.removeItem('refresh_token')
```

---

## âœ… ä¿®å¤éªŒè¯æ¸…å•

- [x] æ›´æ–° DocumentsNew.vue å¯¼å…¥
- [x] æ›¿æ¢æ‰€æœ‰ axios ä¸º apiClient
- [x] ç§»é™¤æ‰‹åŠ¨tokenå¤„ç†
- [x] æ·»åŠ ç™»å½•çŠ¶æ€æ£€æŸ¥
- [x] æ”¹è¿›é”™è¯¯æ¶ˆæ¯æç¤º
- [x] æ·»åŠ 401è‡ªåŠ¨è·³è½¬
- [x] æµ‹è¯•åŠ è½½åˆ†ç±»åŠŸèƒ½
- [x] æµ‹è¯•æ–‡ä»¶å¤¹åˆ›å»º
- [x] æµ‹è¯•æ–‡æ¡£ä¸Šä¼ 
- [x] æµ‹è¯•æ–‡æ¡£ä¸‹è½½

---

**ä¿®å¤å®Œæˆæ—¥æœŸ**: 2025å¹´10æœˆ20æ—¥  
**çŠ¶æ€**: âœ… å·²ä¿®å¤å¹¶æµ‹è¯•é€šè¿‡

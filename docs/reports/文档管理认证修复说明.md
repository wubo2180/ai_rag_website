# 文档管理认证问题修复说明

## 🔧 问题描述
打开文档管理页面时出现：`Unauthorized: /api/documents/categories/`

## ✅ 解决方案

### 问题原因
前端代码使用了 `localStorage.getItem('token')` 获取token，但实际token存储在 `access_token` 中。

### 修复内容

#### 1. 更新 DocumentsNew.vue
- ✅ 导入 `apiClient` 和 `useUserStore`
- ✅ 将所有 axios 调用改为使用 apiClient
- ✅ 移除手动添加 Authorization header
- ✅ 添加登录状态检查
- ✅ 添加401错误自动跳转登录

#### 2. 使用统一的API客户端
`apiClient` 已配置自动添加token到请求头：
```javascript
// src/utils/api.js
apiClient.interceptors.request.use((config) => {
  const token = localStorage.getItem('access_token')
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})
```

---

## 🚀 使用方法

### 1. 确保已登录
访问文档管理页面前，请先登录系统：
- 访问 http://localhost:5173/login
- 输入用户名和密码
- 登录成功后会自动保存 access_token

### 2. 访问文档管理
登录后，点击导航栏的 **📁 文档管理** 按钮即可正常使用。

### 3. Token自动管理
- ✅ 登录时自动保存token
- ✅ 每次请求自动携带token
- ✅ Token过期自动刷新
- ✅ 刷新失败自动跳转登录页

---

## 🔍 验证修复

### 测试步骤
1. **清除浏览器缓存和localStorage**
   - 按 F12 打开开发者工具
   - Application → Storage → Clear site data

2. **重新登录**
   - 访问 http://localhost:5173/login
   - 输入用户名密码登录

3. **访问文档管理**
   - 点击 📁 文档管理
   - 应该能正常看到分类列表

4. **检查网络请求**
   - 打开 Network 标签
   - 查看 `/api/documents/categories/` 请求
   - Headers 中应该有 `Authorization: Bearer <token>`

---

## 📋 修改的文件

```
frontend/src/views/DocumentsNew.vue
- 导入 apiClient 和 useUserStore
- 更新所有API调用方法
- 添加登录状态检查
- 改进错误处理
```

---

## 💡 最佳实践

### 1. 统一使用 apiClient
```javascript
// ❌ 不推荐
import axios from 'axios'
const token = localStorage.getItem('token')
axios.get('/api/xxx', {
  headers: { Authorization: `Bearer ${token}` }
})

// ✅ 推荐
import apiClient from '@/utils/api'
apiClient.get('/api/xxx')  // token自动添加
```

### 2. 检查登录状态
```javascript
import { useUserStore } from '@/stores/user'
const userStore = useUserStore()

if (!userStore.isLoggedIn) {
  ElMessage.warning('请先登录')
  router.push('/login')
  return
}
```

### 3. 错误处理
```javascript
try {
  const response = await apiClient.get('/api/xxx')
  // 处理成功
} catch (error) {
  ElMessage.error('操作失败: ' + (error.response?.data?.detail || error.message))
  if (error.response?.status === 401) {
    router.push('/login')
  }
}
```

---

## 🐛 常见问题

### Q1: 还是显示 Unauthorized？
**A**: 
1. 确认已登录（检查 localStorage 中是否有 access_token）
2. 清除浏览器缓存
3. 重新登录
4. 检查后端服务是否正常运行

### Q2: 登录后立即显示未授权？
**A**: 
1. 检查 token 是否正确保存：
   ```javascript
   console.log(localStorage.getItem('access_token'))
   ```
2. 检查 apiClient 拦截器是否生效
3. 查看 Network 请求头是否包含 Authorization

### Q3: 部分请求正常，部分401？
**A**: 
1. 可能是 token 过期
2. 检查 refresh_token 是否有效
3. 后端 token 刷新接口是否正常

---

## 🔐 Token管理机制

### Token存储
```javascript
// 登录时保存
localStorage.setItem('access_token', token)
localStorage.setItem('refresh_token', refreshToken)

// 请求时自动读取
const token = localStorage.getItem('access_token')
```

### Token刷新
当收到401响应时，自动尝试刷新token：
```javascript
if (error.response?.status === 401) {
  const refreshToken = localStorage.getItem('refresh_token')
  const response = await axios.post('/api/auth/token/refresh/', {
    refresh: refreshToken
  })
  // 保存新token并重试请求
}
```

### Token清除
```javascript
// 退出登录时清除
localStorage.removeItem('access_token')
localStorage.removeItem('refresh_token')
```

---

## ✅ 修复验证清单

- [x] 更新 DocumentsNew.vue 导入
- [x] 替换所有 axios 为 apiClient
- [x] 移除手动token处理
- [x] 添加登录状态检查
- [x] 改进错误消息提示
- [x] 添加401自动跳转
- [x] 测试加载分类功能
- [x] 测试文件夹创建
- [x] 测试文档上传
- [x] 测试文档下载

---

**修复完成日期**: 2025年10月20日  
**状态**: ✅ 已修复并测试通过
